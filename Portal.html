<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Cúpula - Portal</title>
    
    <link rel="shortcut icon" href="favicon/logoACupula.ico" type="image/x-icon">
    <link rel="icon" href="favicon/logoACupula.ico" type="image/x-icon">
    
    <meta property="og:title" content="A Cúpula - Portal">
    <meta property="og:description" content="Portal oficial do servidor A Cúpula SMP.">
    <meta property="og:image" content="images/logoACupula.png">
    <meta name="twitter:card" content="summary_large_image">
   
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="nicepage.css" media="screen">
    <link rel="stylesheet" href="Portal.css" media="screen">

     <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* MUDANÇA DE COR DO FUNDO AQUI */
        body { background-color: #2B2933; font-family: 'Montserrat', 'Inter', sans-serif; color: #e2e8f0; }
        
        .font-medieval { font-family: 'Cinzel', serif; }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        button:disabled { cursor: not-allowed; opacity: 0.7; }
        .select-none { user-select: none; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        
        /* Fundo sutil */
        .bg-pattern {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.05;
        }

        /* Animação RGB para texto */
        .text-rgb {
            background: linear-gradient(to right, #ef4444, #eab308, #22c55e, #3b82f6, #a855f7, #ef4444);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        /* Animação RGB para borda */
        @keyframes border-pulse {
            0% { border-color: #ef4444; }
            20% { border-color: #eab308; }
            40% { border-color: #22c55e; }
            60% { border-color: #3b82f6; }
            80% { border-color: #a855f7; }
            100% { border-color: #ef4444; }
        }
        .border-rgb-anim {
            animation: border-pulse 3s linear infinite;
        }
        @keyframes fade-out-up {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-out-up { animation: fade-out-up 1.5s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="shared-header"></div>

    <div id="root" class="flex-grow flex flex-col"></div>

    <div id="shared-footer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, where, getDocs, deleteDoc, writeBatch, updateDoc, collectionGroup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOZK0kvixerSJSsf0EHob7suL5dBOKdn8",
            authDomain: "acupula.firebaseapp.com",
            projectId: "acupula",
            storageBucket: "acupula.firebasestorage.app",
            messagingSenderId: "268988769992",
            appId: "1:268988769992:web:c642eb669566b6230627fd",
            measurementId: "G-WHBVL0931J"
        };

        const app = initializeApp(firebaseConfig);

        window.firebaseApp = app;
        window.firebaseAuth = { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail };
        window.firebaseFirestore = { getFirestore, collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, where, getDocs, deleteDoc, writeBatch, updateDoc, collectionGroup };
        
        window.onSharedComponentsReady = window.onSharedComponentsReady || [];
        window.onSharedComponentsReady.push(() => {
            window.renderSharedComponents('portal');
        });
    </script>

    <script src="sistema-cupula.js" type="text/babel"></script>

    <script type="text/babel">
        const waitForFirebase = setInterval(() => {
            if (window.firebaseApp) {
                clearInterval(waitForFirebase);
                iniciarApp();
            }
        }, 100);

        const AVATARS = [
            { id: 'villager', icon: 'user', label: 'Aldeão', color: 'text-emerald-600' },
            { id: 'king', icon: 'crown', label: 'Nobre', color: 'text-amber-500' },
            { id: 'mage', icon: 'wand-2', label: 'Mago', color: 'text-purple-500' },
            { id: 'rogue', icon: 'ghost', label: 'Ladino', color: 'text-emerald-500' },
            { id: 'archer', icon: 'target', label: 'Arqueiro', color: 'text-lime-500' },
            { id: 'barbarian', icon: 'axe', label: 'Bárbaro', color: 'text-orange-500' },
            { id: 'cleric', icon: 'heart-pulse', label: 'Clérigo', color: 'text-pink-500' },
            { id: 'druid', icon: 'leaf', label: 'Druida', color: 'text-green-500' },
            { id: 'paladin', icon: 'shield-check', label: 'Paladino', color: 'text-sky-500' },
            { id: 'blacksmith', icon: 'hammer', label: 'Ferreiro', color: 'text-gray-400' },
            { id: 'bard', icon: 'music', label: 'Bardo', color: 'text-yellow-300' },
            { id: 'merchant', icon: 'coins', label: 'Mercador', color: 'text-yellow-600' },
            { id: 'alchemist', icon: 'flask-conical', label: 'Alquimista', color: 'text-teal-400' },
            { id: 'hunter', icon: 'crosshair', label: 'Caçador', color: 'text-green-700' },
            { id: 'assassin', icon: 'sword', label: 'Assassino', color: 'text-slate-800' },
            { id: 'monk', icon: 'hand', label: 'Monge', color: 'text-orange-300' },
            { id: 'warlock', icon: 'flame', label: 'Bruxo', color: 'text-purple-800' },
            { id: 'necromancer', icon: 'skull', label: 'Necromante', color: 'text-zinc-500' },
            { id: 'explorer', icon: 'compass', label: 'Explorador', color: 'text-blue-400' },
            { id: 'miner', icon: 'pickaxe', label: 'Minerador', color: 'text-stone-400' },
            { id: 'builder', icon: 'hammer', label: 'Construtor', color: 'text-yellow-700' },
            { id: 'engineer', icon: 'wrench', label: 'Engenheiro', color: 'text-red-400' },
            { id: 'farmer', icon: 'wheat', label: 'Fazendeiro', color: 'text-lime-600' },
            { id: 'chef', icon: 'utensils', label: 'Cozinheiro', color: 'text-white' },
            { id: 'pirate', icon: 'anchor', label: 'Pirata', color: 'text-blue-800' },
            { id: 'ninja', icon: 'wind', label: 'Ninja', color: 'text-black' },
            { id: 'samurai', icon: 'sword', label: 'Samurai', color: 'text-red-700' },
            { id: 'viking', icon: 'axe', label: 'Viking', color: 'text-blue-300' },
            { id: 'guard', icon: 'shield', label: 'Guarda', color: 'text-slate-500' },
            { id: 'warrior', icon: 'sword', label: 'Guerreiro', color: 'text-red-500' },
        ];

        const Icon = ({ name, className }) => {
            const elementRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && elementRef.current) {
                    elementRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.className = className;
                    elementRef.current.appendChild(i);
                    window.lucide.createIcons({ root: elementRef.current });
                }
            }, [name, className]);
            return <span ref={elementRef} style={{ display: 'contents' }}></span>;
        };

        const RGBBorder = () => {
            const elementRef = React.useRef(null);
            React.useEffect(() => {
                const el = elementRef.current;
                if (!el) return;
                let r = 255, g = 0, b = 0;
                let etapa = 0;
                const interval = setInterval(() => {
                    if (etapa === 0) { g++; if (g === 255) etapa = 1; }
                    else if (etapa === 1) { r--; if (r === 0) etapa = 2; }
                    else if (etapa === 2) { b++; if (b === 255) etapa = 3; }
                    else if (etapa === 3) { g--; if (g === 0) etapa = 4; }
                    else if (etapa === 4) { r++; if (r === 255) etapa = 5; }
                    else if (etapa === 5) { b--; if (b === 0) etapa = 0; }
                    el.style.borderColor = `rgb(${r},${g},${b})`;
                }, 5);
                return () => clearInterval(interval);
            }, []);
            return <div ref={elementRef} className="absolute -inset-0.5 rounded-xl border-[3px] border-solid pointer-events-none z-10" style={{ borderColor: 'rgb(255,0,0)' }}></div>;
        };

        const MysticClock = () => {
            const [time, setTime] = React.useState(new Date());
            React.useEffect(() => {
                const timer = setInterval(() => setTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);
            const dateStr = time.toLocaleDateString('pt-PT', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            const timeStr = time.toLocaleTimeString('pt-PT');
            return (
                <div className="flex flex-col items-center justify-center p-4 mb-6 border-b border-white/5 bg-slate-900/30 backdrop-blur-sm rounded-lg">
                    <div className="text-amber-500/80 font-medieval text-sm uppercase tracking-[0.2em] mb-1">{dateStr}</div>
                    <div className="text-3xl md:text-4xl font-medieval text-white font-bold tracking-widest drop-shadow-[0_0_10px_rgba(245,158,11,0.3)]">{timeStr}</div>
                </div>
            );
        };

        const ModpackSection = () => {
            const [showTutorial, setShowTutorial] = React.useState(false);
            const [tutorialTab, setTutorialTab] = React.useState('original');
            const [showHelp, setShowHelp] = React.useState(false);

            return (
                <div className="bg-slate-900/60 backdrop-blur-md border border-slate-800 rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-indigo-500 to-blue-500"></div>
                    
                    <div className="flex flex-col md:flex-row items-center justify-between gap-6 relative z-10">
                        <div className="flex-1">
                            <h3 className="text-2xl font-bold text-white mb-2 flex items-center gap-2 font-medieval tracking-wide">
                                <Icon name="package" className="w-6 h-6 text-indigo-400" /> Grimório de Mods
                            </h3>
                            <p className="text-slate-400 text-sm mb-4">
                                Para acessar o servidor, você precisa do nosso Modpack oficial. 
                                Ele contém todos os mods, configurações e texturas necessárias para a melhor experiência RPG.
                            </p>
                            
                            <button 
                                onClick={() => setShowTutorial(!showTutorial)}
                                className="text-indigo-400 hover:text-indigo-300 text-sm font-bold flex items-center gap-1 transition"
                            >
                                <Icon name={showTutorial ? "chevron-up" : "chevron-down"} className="w-4 h-4" />
                                {showTutorial ? "Ocultar Tutorial de Instalação" : "Ver Tutorial de Instalação"}
                            </button>
                        </div>

                        <div className="shrink-0 w-full md:w-auto">
                            <a 
                                /* COLOQUE AQUI SEU LINK DO DROPBOX (Lembre de mudar o final para ?dl=1) */
                                href="https://www.dropbox.com/scl/fi/yqf9cdf7hilr6p9rkbld2/mods.zip?rlkey=uixpaugr5qkb7hkqtralk135j&st=5m1hn2ki&dl=1"
                                target="_blank"
                                rel="noopener noreferrer"
                                download
                                className="w-full md:w-auto px-8 py-4 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-3 transition transform hover:scale-105 border border-indigo-400/30 group/btn"
                            >
                                <div className="flex flex-col items-start">
                                    <span className="text-xs text-indigo-200 uppercase tracking-wider">Download Direto • v1.0</span>
                                    <span className="text-lg">BAIXAR MODPACK</span>
                                </div>
                                <Icon name="download" className="w-6 h-6 group-hover/btn:animate-bounce" />
                            </a>
                        </div>
                    </div>

                    {showTutorial && (
                        <div className="mt-6 pt-6 border-t border-slate-800 animate-fade-in">
                            <div className="flex gap-2 sm:gap-4 mb-6 justify-center">
                                <button 
                                    onClick={() => setTutorialTab('original')}
                                    className={`px-4 py-2 rounded-lg font-bold text-xs sm:text-sm transition flex items-center gap-2 ${tutorialTab === 'original' ? 'bg-indigo-600 text-white shadow-lg ring-1 ring-indigo-400' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    <Icon name="shield-check" className="w-4 h-4" /> Minecraft Original
                                </button>
                                <button 
                                    onClick={() => setTutorialTab('pirate')}
                                    className={`px-4 py-2 rounded-lg font-bold text-xs sm:text-sm transition flex items-center gap-2 ${tutorialTab === 'pirate' ? 'bg-amber-600 text-white shadow-lg ring-1 ring-amber-400' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}
                                >
                                    <Icon name="skull" className="w-4 h-4" /> Alternativo (TLauncher)
                                </button>
                            </div>

                            {tutorialTab === 'original' ? (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="grid md:grid-cols-3 gap-4">
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-indigo-500/20 rounded-full flex items-center justify-center text-indigo-400 font-bold mb-3 border border-indigo-500/30">1</div>
                                            <h4 className="text-white font-bold mb-1">Baixe o Arquivo</h4>
                                            <p className="text-xs text-slate-400">Clique no botão de download acima para salvar o arquivo <code className="text-indigo-300">.zip</code> do modpack em seu computador.</p>
                                        </div>
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-indigo-500/20 rounded-full flex items-center justify-center text-indigo-400 font-bold mb-3 border border-indigo-500/30">2</div>
                                            <h4 className="text-white font-bold mb-1">Importe no Launcher</h4>
                                            <p className="text-xs text-slate-400">Abra seu launcher (CurseForge, Prism Launcher ou ATLauncher), clique em <strong>"Criar Instância Personalizada"</strong> ou <strong>"Importar"</strong> e selecione o arquivo baixado.</p>
                                        </div>
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-indigo-500/20 rounded-full flex items-center justify-center text-indigo-400 font-bold mb-3 border border-indigo-500/30">3</div>
                                            <h4 className="text-white font-bold mb-1">Jogue!</h4>
                                            <p className="text-xs text-slate-400">Aguarde a instalação dos mods finalizar, inicie o jogo e conecte-se ao servidor usando o IP disponível no painel abaixo.</p>
                                        </div>
                                    </div>
                                    <div className="p-3 bg-indigo-950/30 border border-indigo-500/20 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-3 text-center sm:text-left">
                                        <div className="flex items-center gap-3 justify-center sm:justify-start">
                                            <div className="p-2 bg-indigo-500/10 rounded-lg"><Icon name="shopping-cart" className="w-5 h-5 text-indigo-400" /></div>
                                            <div>
                                                <p className="text-sm font-bold text-indigo-200">Não tem o Minecraft Original?</p>
                                                <p className="text-xs text-indigo-400/80">Adquira a versão oficial para ter acesso total (Pago)</p>
                                            </div>
                                        </div>
                                        <a href="https://www.minecraft.net/pt-br/store/minecraft-java-bedrock-edition-pc" target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded-lg transition flex items-center gap-2 shadow-lg">
                                            COMPRAR NO SITE OFICIAL <Icon name="external-link" className="w-3 h-3" />
                                        </a>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="grid md:grid-cols-3 gap-4">
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400 font-bold mb-3 border border-amber-500/30">1</div>
                                            <h4 className="text-white font-bold mb-1">Prepare o TLauncher</h4>
                                            <p className="text-xs text-slate-400">No launcher, selecione a versão <strong>Forge 1.20.1</strong> na lista e clique em "Instalar/Entrar" para baixar os arquivos base. Feche o jogo após abrir.</p>
                                        </div>
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400 font-bold mb-3 border border-amber-500/30">2</div>
                                            <h4 className="text-white font-bold mb-1">Instale Manualmente</h4>
                                            <p className="text-xs text-slate-400">Baixe e extraia o modpack. Abra a pasta do jogo (ícone de pasta no launcher) e copie as pastas <code>mods</code> e <code>config</code> do download para dentro dela.</p>
                                        </div>
                                        <div className="bg-slate-950/50 p-4 rounded-xl border border-slate-800">
                                            <div className="w-8 h-8 bg-amber-500/20 rounded-full flex items-center justify-center text-amber-400 font-bold mb-3 border border-amber-500/30">3</div>
                                            <h4 className="text-white font-bold mb-1">Jogue!</h4>
                                            <p className="text-xs text-slate-400">Certifique-se de que a versão selecionada ainda é <strong>Forge 1.20.1</strong>, entre no jogo e conecte-se ao servidor.</p>
                                        </div>
                                    </div>
                                    <div className="p-3 bg-amber-950/30 border border-amber-500/20 rounded-xl flex flex-col sm:flex-row items-center justify-between gap-3 text-center sm:text-left">
                                        <div className="flex items-center gap-3 justify-center sm:justify-start">
                                            <div className="p-2 bg-amber-500/10 rounded-lg"><Icon name="download" className="w-5 h-5 text-amber-400" /></div>
                                            <div>
                                                <p className="text-sm font-bold text-amber-200">Não tem o Launcher?</p>
                                                <p className="text-xs text-amber-400/80">Baixe o TLauncher gratuitamente para jogar</p>
                                            </div>
                                        </div>
                                        <a href="https://tlauncher.org/en/" target="_blank" rel="noopener noreferrer" className="px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold rounded-lg transition flex items-center gap-2 shadow-lg">
                                            BAIXAR TLAUNCHER <Icon name="external-link" className="w-3 h-3" />
                                        </a>
                                    </div>
                                </div>
                            )}

                            <div className="mt-4 flex justify-end">
                                <div className="relative inline-block">
                                    <button 
                                        onClick={() => setShowHelp(!showHelp)}
                                        className="flex items-center gap-2 cursor-pointer opacity-80 hover:opacity-100 transition-all duration-300 focus:outline-none"
                                    >
                                        <span className={`text-[10px] uppercase tracking-wider font-bold transition-colors ${showHelp ? 'text-purple-400' : 'text-slate-500'}`}>Ajuda</span>
                                        <div className={`p-2 rounded-full border transition-all ${showHelp ? 'bg-purple-500/10 border-purple-500/50' : 'bg-slate-800/50 border-slate-700 hover:border-slate-600'}`}>
                                            <Icon name="life-buoy" className={`w-4 h-4 ${showHelp ? 'text-purple-400' : 'text-slate-400'}`} />
                                        </div>
                                    </button>

                                    {showHelp && (
                                    <div className="absolute bottom-full right-0 mb-3 w-72 bg-slate-950 border border-purple-500/30 p-4 rounded-xl shadow-2xl animate-fade-in z-50">
                                        <div className="flex items-start gap-3 mb-3">
                                            <div className="p-2 bg-purple-500/10 rounded-lg shrink-0 border border-purple-500/20"><Icon name="life-buoy" className="w-5 h-5 text-purple-400" /></div>
                                            <div>
                                                <p className="text-sm font-bold text-purple-200">Problemas na Instalação?</p>
                                                <p className="text-xs text-slate-400 mt-1 leading-relaxed">Não se preocupe! Nossa equipe de staff está pronta para te ajudar no Discord.</p>
                                            </div>
                                        </div>
                                        <a href="https://discord.gg/acupula" target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 w-full py-2.5 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-lg transition shadow-lg border border-purple-400/20 group/btn">PEDIR AJUDA AGORA <Icon name="arrow-right" className="w-3 h-3 group-hover/btn:translate-x-1 transition-transform" /></a>
                                        <div className="absolute -bottom-1.5 right-3 w-3 h-3 bg-slate-950 border-b border-r border-purple-500/30 transform rotate-45"></div>
                                    </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const checkMinecraftNickExists = async (nick) => {
            if (!nick) return false;
            try {
                // Usando PlayerDB que possui melhores headers CORS para verificação via frontend
                const response = await fetch(`https://playerdb.co/api/player/minecraft/${nick}`);
                const data = await response.json();
                return data.success === true;
            } catch (error) {
                console.warn("Erro na verificação do nick:", error);
                return true;
            }
        };

        // 2. Auth Screen
        const AuthScreen = ({ view, setView, handleLogin, handleRegister, handleForgotPassword, isSubmitting, error, formState, setFormState }) => {
            const [showPassword, setShowPassword] = React.useState(false);
            const [showConfirm, setShowConfirm] = React.useState(false);
            const [isPirate, setIsPirate] = React.useState(false);
            const [nickStatus, setNickStatus] = React.useState('idle'); // idle, checking, valid, invalid
            const [emailStatus, setEmailStatus] = React.useState('idle');
            const [agreedToTerms, setAgreedToTerms] = React.useState(false);

            const isPasswordMismatch = view === 'register' && formState.confirmPassword.length > 0 && formState.password !== formState.confirmPassword;

            const updateForm = (field, value) => {
                setFormState(prev => ({ ...prev, [field]: value }));
                if (field === 'minecraftNick') setNickStatus('idle'); // Reset on change
                if (field === 'email') setEmailStatus('idle');
            };

            const handlePirateCheck = (e) => {
                setIsPirate(e.target.checked);
                setNickStatus('idle'); // Reset nick status when mode changes
            };

            const handleNickBlur = async () => {
                if (!formState.minecraftNick || isPirate) return;
                setNickStatus('checking');
                const exists = await checkMinecraftNickExists(formState.minecraftNick);
                setNickStatus(exists ? 'valid' : 'invalid');
            };

            const handleEmailBlur = () => {
                if (!formState.email) return;
                const isValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(formState.email);
                setEmailStatus(isValid ? 'valid' : 'invalid');
            };

            return (
                <div className="flex-grow flex items-center justify-center p-4 relative min-h-[600px]">
                    <div className="absolute inset-0 bg-pattern z-0 pointer-events-none"></div>
                    
                    <div className="max-w-md w-full bg-slate-900/80 backdrop-blur-md border border-slate-800 rounded-2xl p-6 sm:p-8 shadow-2xl relative z-10 animate-fade-in">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-purple-500/30">
                                <Icon name={view === 'login' ? 'lock' : 'user-plus'} className="w-8 h-8 text-purple-500" />
                            </div>
                            <h3 className="text-2xl font-bold text-white mb-2">{view === 'login' ? 'Acesso ao Portal' : 'Novo Recruta'}</h3>
                            <p className="text-slate-400 text-sm">Identifique-se para entrar na Cúpula.</p>
                        </div>

                        <form onSubmit={view === 'login' ? handleLogin : (e) => handleRegister(e, isPirate, agreedToTerms)} className="space-y-4">
                            {view === 'register' && (
                                <>
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400 ml-1">Seu Nome <span className="text-[10px] text-slate-500 font-normal">(Nome e Sobrenome)</span></label>
                                        <input required maxLength={25} type="text" placeholder="Ex: João Silva" value={formState.name} onChange={e => updateForm('name', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-purple-500 transition" />
                                    </div>

                                    <div className="space-y-1 mb-2">
                                        <label className="text-xs text-amber-500/80 font-bold ml-1">{isPirate ? 'Nick Exato (Para Login)' : 'Nick do Minecraft'}</label>
                                        <div className="relative">
                                            <input 
                                                type="text" 
                                                placeholder={isPirate ? "Nick que usará no jogo" : "Ex: Steve"} 
                                                value={formState.minecraftNick} 
                                                onChange={e => updateForm('minecraftNick', e.target.value)} 
                                                onBlur={handleNickBlur}
                                                className={`w-full bg-slate-950 border ${nickStatus === 'invalid' && !isPirate ? 'border-red-500' : (nickStatus === 'valid' && !isPirate ? 'border-green-500' : 'border-amber-900/50')} rounded-lg p-3 pl-10 text-amber-500 font-mono outline-none focus:border-amber-500 transition`} 
                                            />
                                            <div className="absolute left-3 top-3.5 text-amber-700">
                                                <Icon name="gamepad-2" className="w-5 h-5" />
                                            </div>
                                            {nickStatus === 'checking' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="loader-2" className="w-5 h-5 animate-spin text-amber-500" /></div>}
                                            {nickStatus === 'valid' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="check" className="w-5 h-5 text-green-500" /></div>}
                                            {nickStatus === 'invalid' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="x" className="w-5 h-5 text-red-500" /></div>}
                                        </div>
                                        {nickStatus === 'invalid' && !isPirate && <p className="text-xs text-red-400 ml-1">Este nick não existe no Minecraft Original.</p>}
                                    </div>

                                    <div className="space-y-1 -mt-2">
                                        <div className="flex items-center justify-start gap-2">
                                            <input 
                                                id="pirate-check"
                                                type="checkbox" 
                                                checked={isPirate} 
                                                onChange={handlePirateCheck}
                                                className="h-4 w-4 bg-slate-800 border-slate-600 rounded text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900"
                                            />
                                            <label htmlFor="pirate-check" className="text-xs text-slate-400 cursor-pointer select-none">Não tenho Minecraft Original</label>
                                        </div>
                                    </div>

                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400 ml-1">Data de Nascimento</label>
                                        <input required type="date" value={formState.birthDate} onChange={e => updateForm('birthDate', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-purple-500 transition" />
                                    </div>
                                </>
                            )}
                            
                            <div className="space-y-1">
                                <label className="text-xs text-slate-400 ml-1">{view === 'login' ? 'Email' : 'Email Válido'}</label>
                                <div className="relative">
                                    <input required type="text" value={formState.email} onChange={e => updateForm('email', e.target.value)} onBlur={view === 'register' ? handleEmailBlur : undefined} className={`w-full bg-slate-950 border ${emailStatus === 'invalid' && view === 'register' ? 'border-red-500' : 'border-slate-700'} rounded-lg p-3 text-white outline-none focus:border-purple-500 transition`} />
                                    {view === 'register' && (
                                        <>
                                            {emailStatus === 'valid' && <div className="absolute right-3 top-3.5"><Icon name="check" className="w-5 h-5 text-green-500" /></div>}
                                            {emailStatus === 'invalid' && <div className="absolute right-3 top-3.5"><Icon name="x" className="w-5 h-5 text-red-500" /></div>}
                                        </>
                                    )}
                                </div>
                                {emailStatus === 'invalid' && view === 'register' && <p className="text-xs text-red-400 ml-1">Formato de email inválido.</p>}
                            </div>
                            
                            <div className="space-y-1 relative">
                                <label className="text-xs text-slate-400 ml-1">Senha</label>
                                <div className="relative group">
                                    <input required type={showPassword ? "text" : "password"} value={formState.password} onChange={e => updateForm('password', e.target.value)} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-purple-500 transition pr-10" />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3.5 text-slate-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                        <Icon name={showPassword ? "eye-off" : "eye"} className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>

                            {view === 'register' && (
                                <div className="space-y-1 relative">
                                    <label className="text-xs text-slate-400 ml-1">Confirme sua Senha</label>
                                    <div className="relative group">
                                        <input required type={showConfirm ? "text" : "password"} value={formState.confirmPassword} onChange={e => updateForm('confirmPassword', e.target.value)} className={`w-full bg-slate-950 border ${isPasswordMismatch ? 'border-red-500' : 'border-slate-700'} rounded-lg p-3 text-white outline-none focus:border-purple-500 transition pr-10`} />
                                        <button type="button" onClick={() => setShowConfirm(!showConfirm)} className="absolute right-3 top-3.5 text-slate-500 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity">
                                            <Icon name={showConfirm ? "eye-off" : "eye"} className="w-5 h-5" />
                                        </button>
                                    </div>
                                    {isPasswordMismatch && <p className="text-xs text-red-400 ml-1">As senhas não coincidem.</p>}
                                </div>
                            )}

                            {view === 'register' && (
                                <div className="p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg text-amber-300 text-xs text-center flex items-center justify-center gap-2">
                                    <Icon name="alert-triangle" className="w-5 h-5 shrink-0" />
                                    <span>Por sua segurança, <strong><span className="text-red-400 underline uppercase">NÃO</span> utilize o mesmo email e senha</strong> da sua conta Mojang/Minecraft.</span>
                                </div>
                            )}

                            {view === 'register' && (
                                <div className="space-y-2 pt-2">
                                    <label className="text-xs text-slate-400 ml-1">Escolha seu Brasão (Classe)</label>
                                    <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
                                        {AVATARS.map(av => (
                                            <div key={av.id} title={av.label} onClick={() => updateForm('selectedAvatar', av.id)} className={`cursor-pointer p-2 rounded-lg border flex flex-col items-center justify-center gap-1 hover:bg-slate-800 transition ${formState.selectedAvatar === av.id ? 'border-purple-500 bg-purple-500/20' : 'border-slate-700 bg-slate-950'}`}>
                                                <Icon name={av.icon} className={`w-6 h-6 ${av.color}`} />
                                                <span className="text-[10px] text-slate-400 text-center leading-tight">{av.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {view === 'register' && (
                                <div className="flex items-start gap-3 pt-2">
                                    <input 
                                        id="terms-check"
                                        type="checkbox" 
                                        checked={agreedToTerms} 
                                        onChange={(e) => setAgreedToTerms(e.target.checked)}
                                        className="h-4 w-4 mt-0.5 bg-slate-800 border-slate-600 rounded text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900 shrink-0"
                                    />
                                    <label htmlFor="terms-check" className="text-xs text-slate-400 cursor-pointer select-none">Eu li, compreendi e aceito os <a href="termos.html" target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:text-purple-300 underline">Termos de Serviço e Política de Privacidade</a>.</label>
                                </div>
                            )}

                            {view === 'login' && (
                                <div className="text-right">
                                    <button type="button" onClick={() => handleForgotPassword(formState.email)} className="text-xs text-purple-400 hover:text-purple-300 hover:underline transition">Esqueci minha senha</button>
                                </div>
                            )}

                            {error && <div className="p-3 bg-red-500/10 border border-red-500/20 rounded text-red-400 text-sm text-center flex items-center justify-center gap-2"><Icon name="alert-circle" className="w-4 h-4" /> {error}</div>}

                            <button type="submit" disabled={isSubmitting || (view === 'register' && (!agreedToTerms || (nickStatus === 'invalid' && !isPirate) || emailStatus === 'invalid' || isPasswordMismatch))} className="w-full bg-gradient-to-r from-purple-700 to-indigo-600 hover:from-purple-600 hover:to-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3.5 rounded-lg shadow-lg flex justify-center items-center gap-2 transition transform active:scale-95 mt-4">
                                {isSubmitting ? 'PROCESSANDO...' : (view === 'login' ? 'ENTRAR NO SISTEMA' : 'CONFIRMAR REGISTRO')} 
                                {!isSubmitting && <Icon name={view === 'login' ? 'arrow-right' : 'check'} className="w-4 h-4" />}
                            </button>
                        </form>

                        <div className="mt-6 pt-6 border-t border-slate-800 text-center">
                            <p className="text-slate-500 text-sm mb-2">{view === 'login' ? 'Ainda não tem cadastro?' : 'Já possui uma conta?'}</p>
                            <button className="text-purple-400 hover:text-purple-300 font-bold hover:underline transition" onClick={() => setView(view === 'login' ? 'register' : 'login')}>
                                {view === 'login' ? 'Criar Nova Conta' : 'Voltar para Login'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 3. Dashboard Screen
        const DashboardScreen = ({ user, donations, allUsers, playerCount, totalCollected, serverGoal, maxHeroes, daysRemaining, nextResetFormatted, handleOpenPixModal, donationAmount, setDonationAmount, error, isAdmin, handleEditDonation, handleDeleteDonation, handleDeleteUser, handleUpdateAvatar, setView, isHeroesRoomFull, hasDonated, isGoalReached, handleOpenHistory, adminEmail, isServerOnline, handleUpdateServerStatus, serverIp, handleUpdateServerIp }) => {
            const progressPercent = Math.min(100, (totalCollected / serverGoal) * 100);
            const remainingGoal = Math.max(0, serverGoal - totalCollected);
            const getAvatarInfo = (id) => AVATARS.find(a => a.id === id) || AVATARS[0];
            const [avatarEditTarget, setAvatarEditTarget] = React.useState(null);
            const [showLoyalty, setShowLoyalty] = React.useState(false);
            const [ipCopied, setIpCopied] = React.useState(false);
            const [isEditingIp, setIsEditingIp] = React.useState(false);
            const [newIp, setNewIp] = React.useState(serverIp);

            React.useEffect(() => {
                setNewIp(serverIp);
            }, [serverIp]);

            const onSaveIp = () => {
                handleUpdateServerIp(newIp);
                setIsEditingIp(false);
            };

            const handleCopyIp = async () => {
                try {
                    await navigator.clipboard.writeText(serverIp);
                    setIpCopied(true);
                    setTimeout(() => setIpCopied(false), 2000);
                } catch (err) { console.error(err); }
            };

            return (
                <main className="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-8 animate-fade-in relative flex-grow w-full">
                    <div className="absolute inset-0 bg-pattern z-0 pointer-events-none"></div>
                    
                    <div className="relative z-10">
                        <MysticClock />

                        {avatarEditTarget && (
                            <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                                <div className="bg-slate-900/90 backdrop-blur-md border border-purple-500/50 rounded-2xl max-w-lg w-full p-6 shadow-2xl relative flex flex-col max-h-[85vh]">
                                    <button onClick={() => setAvatarEditTarget(null)} className="absolute top-4 right-4 text-slate-400 hover:text-white z-10"><Icon name="x" className="w-6 h-6" /></button>
                                    <h3 className="text-xl font-bold text-white mb-4 text-center shrink-0">Alterar Brasão</h3>
                                    <div className="grid grid-cols-3 sm:grid-cols-6 gap-3 overflow-y-auto custom-scrollbar pr-2">
                                        {AVATARS.map(av => (
                                            <div key={av.id} onClick={() => { handleUpdateAvatar(avatarEditTarget, av.id); setAvatarEditTarget(null); }} 
                                                 className="cursor-pointer p-3 rounded-lg border border-slate-700 bg-slate-950 hover:bg-purple-500/20 hover:border-purple-500 transition flex flex-col items-center gap-2">
                                                <Icon name={av.icon} className={`w-6 h-6 ${av.color}`} />
                                                <span className="text-[10px] text-slate-400">{av.label}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="relative mb-4 md:mb-8">
                            {!user && (
                                <div className="absolute inset-0 z-20 flex items-center justify-center bg-slate-900/60 backdrop-blur-[2px] rounded-xl border border-slate-800/50 transition-all hover:bg-slate-900/70">
                                    <button onClick={() => setView('login')} className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white text-xs font-bold rounded-full border border-slate-600 shadow-lg transition transform hover:scale-105 group">
                                        <Icon name="lock" className="w-3 h-3 text-amber-500" />
                                        <span>ENTRAR PARA VER</span>
                                    </button>
                                </div>
                            )}
                            <div className={`p-4 rounded-xl bg-gradient-to-r from-indigo-900/40 to-slate-900/60 backdrop-blur-md border border-indigo-500/30 flex flex-col md:flex-row items-center justify-between shadow-lg gap-4 ${!user ? 'blur-md select-none pointer-events-none' : ''}`}>
                                <div className="flex items-center gap-4">
                                    <div className="p-3 bg-indigo-500/20 rounded-full border border-indigo-500/30">
                                        <Icon name="calendar-clock" className="w-6 h-6 text-indigo-400" />
                                    </div>
                                    <div>
                                        <p className="text-sm font-bold text-indigo-200 uppercase tracking-wide">Data de Vencimento</p>
                                        <p className="text-xs text-indigo-400">Data prevista: <span className="text-white font-mono">{nextResetFormatted}</span></p>
                                    </div>
                                </div>
                                <div className="text-center md:text-right bg-black/20 px-6 py-2 rounded-lg">
                                    <p className="text-xs uppercase tracking-widest text-indigo-400 mb-1">Tempo Restante</p>
                                    <p className="text-2xl font-bold text-white font-mono">{daysRemaining} dias</p>
                                </div>
                            </div>
                        </div>

                        <div className="grid lg:grid-cols-12 gap-4 lg:gap-8">
                            <div className="lg:col-span-7 space-y-6">
                                <div className="relative">
                                    {!user && (
                                        <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm rounded-2xl border border-slate-800 p-6 text-center animate-fade-in">
                                            <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-slate-700 shadow-2xl">
                                                <Icon name="lock" className="w-8 h-8 text-slate-500" />
                                            </div>
                                            <h3 className="text-xl font-bold text-white mb-2 font-medieval tracking-wide">Meta Restrita</h3>
                                            <button onClick={() => setView('login')} className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition border border-slate-600">
                                                <Icon name="log-in" className="w-4 h-4" />
                                                VER PROGRESSO
                                            </button>
                                        </div>
                                    )}
                                    <div className={`relative overflow-hidden rounded-2xl border p-8 shadow-2xl transition backdrop-blur-md ${isGoalReached ? 'bg-emerald-950/30 border-emerald-500/50' : 'bg-slate-900/60 border-amber-500/30'} ${!user ? 'blur-md select-none pointer-events-none' : ''}`}>
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <h3 className="text-sm uppercase tracking-widest text-slate-400 font-bold mb-1">Pagamento do Servidor para esse Mês</h3>
                                            <div className="flex items-baseline gap-2">
                                                <span className={`text-3xl sm:text-4xl md:text-5xl font-black whitespace-nowrap ${isGoalReached ? 'text-emerald-400' : 'text-white'}`}>
                                                    R$ {totalCollected.toFixed(2)}
                                                </span>
                                                <span className="text-slate-500 text-lg">/ {serverGoal}</span>
                                            </div>
                                        </div>
                                        <div className={`p-4 rounded-full ${isGoalReached ? 'bg-emerald-500/20' : 'bg-amber-500/10'}`}>
                                            <Icon name={isGoalReached ? "check-circle-2" : "coins"} className={`w-10 h-10 ${isGoalReached ? "text-emerald-500" : "text-amber-500"}`} />
                                        </div>
                                    </div>
                                    
                                    <div className="w-full h-6 bg-slate-950 rounded-full overflow-hidden mb-3 border border-white/5 shadow-inner">
                                        <div className={`h-full transition-all duration-1000 shadow-[0_0_15px_rgba(0,0,0,0.5)] ${isGoalReached ? 'bg-emerald-500' : 'bg-gradient-to-r from-amber-600 via-orange-500 to-amber-400'}`} style={{ width: `${progressPercent}%` }}></div>
                                    </div>
                                    
                                    <div className="flex justify-between text-xs font-mono font-bold">
                                        <span className={isGoalReached ? 'text-emerald-400' : 'text-amber-400'}>{progressPercent.toFixed(1)}% COMPLETADO</span>
                                        <span className="text-slate-400">{isGoalReached ? 'META ATINGIDA!' : `FALTAM R$ ${remainingGoal.toFixed(2)}`}</span>
                                    </div>
                                    </div>
                                </div>

                                {!isGoalReached && !hasDonated && !isHeroesRoomFull && (
                                    <div className="bg-slate-900/60 backdrop-blur-md border border-slate-800 rounded-2xl p-6 shadow-xl relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 w-32 h-32 bg-purple-500/5 rounded-full blur-3xl group-hover:bg-purple-500/10 transition"></div>
                                        
                                        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2 relative z-10">
                                            <Icon name="scroll" className="w-6 h-6 text-purple-400" /> Contribuir com o servidor
                                        </h3>
                                        
                                        <div className="space-y-4 relative z-10">
                                            {user ? (
                                                <>
                                                    <div>
                                                        <label className="block text-sm text-slate-400 mb-2 font-medium">Quanto deseja contribuir?</label>
                                                        <div className="relative">
                                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">R$</span>
                                                            <input 
                                                                type="number" 
                                                                min="2" 
                                                                max={remainingGoal} 
                                                                step="0.50" 
                                                                value={donationAmount} 
                                                                onChange={(e) => setDonationAmount(e.target.value)} 
                                                                className="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 pl-10 text-white focus:border-amber-500 outline-none font-mono text-xl shadow-inner transition" 
                                                                placeholder="0.00"
                                                            />
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3 text-xs text-purple-300 flex gap-2 items-start">
                                                        <Icon name="info" className="w-4 h-4 shrink-0 mt-0.5" />
                                                        <p>Sua contribuição concede um brilho lendário e destaque de honra ao seu nome. O valor mínimo é de R$ 2,00.</p>
                                                    </div>
                                                    
                                                    <div 
                                                        className={`bg-cyan-500/10 border border-cyan-500/20 rounded-lg p-3 text-xs text-cyan-300 flex gap-2 items-start cursor-help transition-all duration-300 ${showLoyalty ? 'w-full' : 'w-fit hover:bg-cyan-500/20'}`}
                                                        onMouseEnter={() => setShowLoyalty(true)}
                                                        onMouseLeave={() => setShowLoyalty(false)}
                                                        onClick={() => setShowLoyalty(!showLoyalty)}
                                                    >
                                                        <Icon name="gem" className={`w-4 h-4 shrink-0 ${showLoyalty ? 'mt-0.5' : ''}`} />
                                                        {showLoyalty && <p className="animate-fade-in"><strong>Recompensa de Lealdade:</strong> Ao contribuir por <strong>2 meses consecutivos</strong>, você ganha o direito de ter um item exclusivo no jogo com o nome que quiser!</p>}
                                                    </div>

                                                    {error && <p className="text-red-400 text-sm bg-red-900/20 p-3 rounded-lg border border-red-500/20 flex gap-2 items-center"><Icon name="x-circle" className="w-4 h-4" /> {error}</p>}
                                                    
                                                    <button onClick={handleOpenPixModal} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 border-t border-white/10">
                                                        <Icon name="qr-code" className="w-5 h-5" /> GERAR PIX
                                                    </button>
                                                </>
                                            ) : (
                                                <>
                                                    <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/40 z-20 backdrop-blur-[2px] p-6 text-center">
                                                        <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-slate-700 shadow-lg">
                                                            <Icon name="lock" className="w-8 h-8 text-slate-500" />
                                                        </div>
                                                        <h3 className="text-white font-bold mb-2 text-lg">Área de Doação</h3>
                                                        <p className="text-slate-400 text-sm mb-6 max-w-[200px]">Identifique-se para contribuir com o Servidor.</p>
                                                        <button onClick={() => setView('login')} className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-bold border border-slate-600 transition flex items-center gap-2">
                                                            <Icon name="key" className="w-4 h-4" /> Entrar para contribuir
                                                        </button>
                                                    </div>
                                                    
                                                    <div className="blur-md select-none pointer-events-none opacity-80 space-y-4">
                                                        <div>
                                                            <label className="block text-sm text-slate-400 mb-2 font-medium">Quanto deseja contribuir?</label>
                                                            <div className="relative">
                                                                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500">R$</span>
                                                                <input type="number" className="w-full bg-slate-950 border border-slate-700 rounded-xl p-4 pl-10 text-white outline-none font-mono text-xl shadow-inner" placeholder="0.00" value="50.00" readOnly />
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3 text-xs text-purple-300 flex gap-2 items-start">
                                                            <Icon name="info" className="w-4 h-4 shrink-0 mt-0.5" />
                                                            <p>Sua contribuição concede um brilho lendário e destaque de honra ao seu nome. O valor mínimo é de R$ 2,00.</p>
                                                        </div>
                                                        
                                                        <button className="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 border-t border-white/10">
                                                            <Icon name="qr-code" className="w-5 h-5" /> GERAR PIX
                                                        </button>
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                )}

                                {hasDonated && (
                                    <div className="bg-gradient-to-br from-slate-900/80 to-purple-900/20 backdrop-blur-md border border-purple-500/30 rounded-2xl p-8 text-center shadow-lg">
                                        <div className="mx-auto bg-purple-500/20 w-16 h-16 rounded-full flex items-center justify-center mb-4 border border-purple-500/30 animate-pulse">
                                            <Icon name="check" className="w-8 h-8 text-purple-400" />
                                        </div>
                                        <h3 className="text-xl font-bold text-white mb-2">Doação Recebida</h3>
                                        <p className="text-slate-400">Seu nome já consta nos pagamentos deste ciclo. Obrigado!</p>
                                    </div>
                                )}

                                {isHeroesRoomFull && !hasDonated && !isGoalReached && (
                                    <div className="bg-slate-900/60 backdrop-blur-md border border-amber-500/30 rounded-2xl p-8 text-center shadow-lg">
                                        <div className="mx-auto bg-amber-500/10 w-16 h-16 rounded-full flex items-center justify-center mb-4 border border-amber-500/30">
                                            <Icon name="users" className="w-8 h-8 text-amber-500" />
                                        </div>
                                        <h3 className="text-xl font-bold text-white mb-2">Sala dos Heróis Lotada</h3>
                                        <p className="text-slate-400">O limite de {maxHeroes} heróis foi atingido por este ciclo.</p>
                                    </div>
                                )}
                            </div>

                            <div className="lg:col-span-5">
                                <div className="bg-slate-900/60 backdrop-blur-md border border-slate-800 rounded-2xl shadow-xl flex flex-col h-auto min-h-[550px] lg:h-[700px]">
                                    <div className="p-5 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-sm rounded-t-2xl">
                                        <h3 className="font-bold text-amber-500 flex items-center gap-2 tracking-wide font-medieval text-lg">
                                            <Icon name="shield" className="w-5 h-5" /> Sala dos Heróis
                                        </h3>
                                        <div className="flex items-center gap-2">
                                            <div className="group relative flex items-center z-50">
                                                <Icon name="help-circle" className="w-4 h-4 text-slate-500 cursor-help hover:text-slate-300" />
                                                <div className="absolute right-0 bottom-6 w-48 bg-slate-900 border border-slate-700 p-3 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 text-xs text-slate-300">
                                                    <p className="mb-2 font-bold text-slate-200">Identificação:</p>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <img src="favicon/mineorigi.ico" className="w-3 h-3" title="Minecraft Original" />
                                                        <span>Minecraft Original</span>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <img src="favicon/mineorigipremium.ico" className="w-3 h-3" title="Minecraft Original + Pagante" />
                                                        <span>Original + Pagante</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <span className="text-xs font-bold bg-slate-800 text-slate-400 px-2 py-1 rounded border border-slate-700">
                                                {playerCount} / {maxHeroes}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className={`p-4 space-y-3 flex-1 bg-slate-900/50 relative rounded-b-2xl ${!user ? 'overflow-hidden' : 'overflow-y-auto custom-scrollbar'}`}>
                                        {!user ? (
                                            <>
                                            <div className="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/40 z-20 backdrop-blur-[2px] p-6 text-center">
                                                <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 border border-slate-700 shadow-lg">
                                                    <Icon name="lock" className="w-8 h-8 text-slate-500" />
                                                </div>
                                                <h3 className="text-white font-bold mb-2 text-lg">Pergaminho Protegido</h3>
                                                <p className="text-slate-400 text-sm mb-6 max-w-[200px]">Apenas membros da Cúpula podem ver quem está na Sala dos Heróis.</p>
                                                <button onClick={() => setView('login')} className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-sm font-bold border border-slate-600 transition flex items-center gap-2">
                                                    <Icon name="key" className="w-4 h-4" /> Entrar para ver
                                                </button>
                                            </div>
                                            <div className="blur-md select-none pointer-events-none opacity-80 space-y-3">
                                                {Array.from({ length: 8 }).map((_, i) => (
                                                    <div key={i} className="flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-xl bg-slate-950/40 border border-slate-800">
                                                        <div className="text-xs text-slate-600 font-mono w-4">#{i + 1}</div>
                                                        <div className="w-12 h-12 rounded-lg bg-slate-900 border-2 border-slate-800"></div>
                                                        <div className="flex-1 space-y-2">
                                                            <div className="h-4 bg-slate-800 rounded w-24"></div>
                                                            <div className="h-3 bg-slate-800/50 rounded w-16"></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                            </>
                                        ) : (
                                            allUsers.length === 0 ? (
                                                <div className="h-full flex flex-col items-center justify-center text-slate-600 opacity-60">
                                                    <Icon name="ghost" className="w-12 h-12 mb-3" />
                                                    <p className="text-sm font-medieval tracking-widest">Nenhum herói se apresentou...</p>
                                                </div>
                                            ) : (
                                                [...allUsers].sort((a, b) => {
                                                    const isAdA = a.email === adminEmail;
                                                    const isAdB = b.email === adminEmail;
                                                    if (isAdA && !isAdB) return 1;
                                                    if (!isAdA && isAdB) return -1;

                                                    const donationA = donations.find(d => d.userId === a.uid);
                                                    const donationB = donations.find(d => d.userId === b.uid);
                                                const isDonorA = donationA && donationA.amount > 0;
                                                const isDonorB = donationB && donationB.amount > 0;

                                                // Prioriza quem doou (aparece no topo), mas sem ordenar pelo valor
                                                if (isDonorA !== isDonorB) return isDonorB - isDonorA;

                                                    const nameA = a.minecraftNick || a.name || '';
                                                    const nameB = b.minecraftNick || b.name || '';
                                                    return nameA.localeCompare(nameB);
                                                }).map((u, index) => {
                                                    const donation = donations.find(d => d.userId === u.uid);
                                                    const isDonor = !!donation;
                                                    const isMe = user && user.uid === u.uid;
                                                    const isTargetAdmin = u.email === adminEmail;
                                                    const canEditAvatar = isAdmin || isMe;
                                                    const showControls = isAdmin || isMe;
                                                    const showValue = isDonor && (isAdmin || isMe);
                                                    
                                                    return (
                                                        <React.Fragment key={u.uid}>
                                                        {isTargetAdmin && index > 0 && (
                                                            <div className="my-5 border-t border-slate-700 w-full"></div>
                                                        )}
                                                        <div className={`flex items-center gap-3 sm:gap-4 p-3 sm:p-4 rounded-xl bg-slate-950/40 backdrop-blur-sm border group relative transition duration-300 ${isDonor ? 'border-rgb-anim shadow-lg' : 'border-slate-800 hover:border-slate-600'}`}>
                                                            <div className="text-xs text-slate-600 font-mono w-4">#{isTargetAdmin ? '0' : index + 1}</div>
                                                            <div onClick={() => canEditAvatar && setAvatarEditTarget(u.uid)} className={`w-12 h-12 rounded-lg bg-slate-900 flex items-center justify-center border-2 ${isDonor ? 'border-transparent' : (isMe ? 'border-purple-500' : 'border-slate-800')} ${canEditAvatar ? 'cursor-pointer hover:scale-110 hover:border-white transition-transform' : ''} relative group/avatar`} title={canEditAvatar ? "Clique para alterar o brasão" : ""}>
                                                                {isDonor && (
                                                                    <RGBBorder />
                                                                )}
                                                                <img src={`https://minotar.net/helm/${u.minecraftNick || (isTargetAdmin ? 'MHF_Enderman' : 'MHF_Steve')}/100.png`} alt="Skin" className="w-full h-full object-cover rounded-lg" />
                                                                
                                                                {/* Brasão (Classe) como emblema no canto */}
                                                                <div className="absolute -bottom-1 -right-1 bg-slate-900 rounded-full p-1 border border-slate-700 z-20 shadow-sm" title={getAvatarInfo(u.avatarId).label}>
                                                                    <Icon name={getAvatarInfo(u.avatarId).icon} className={`w-3 h-3 ${getAvatarInfo(u.avatarId).color}`} />
                                                                </div>
                                                                
                                                                {canEditAvatar && <div className="absolute inset-0 bg-black/50 rounded-lg flex items-center justify-center opacity-0 group-hover/avatar:opacity-100 transition-opacity z-30"><Icon name="pencil" className="w-4 h-4 text-white" /></div>}
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center gap-1">
                                                                    {u.isOriginal && <img src={`favicon/${isDonor ? 'mineorigipremium.ico' : 'mineorigi.ico'}`} className="w-4 h-4 shrink-0" title={isDonor ? "Minecraft Original + Pagante" : "Minecraft Original"} />}
                                                                    <div className="truncate flex-1">
                                                                        <span className={`font-bold text-base align-middle ${isDonor ? 'text-rgb' : 'text-slate-200'}`}>
                                                                        {u.minecraftNick || u.name || 'Desconhecido'}
                                                                        </span>
                                                                    {u.minecraftNick && u.name && u.name !== u.minecraftNick && (
                                                                        <span className="text-[11px] text-yellow-500 font-normal ml-1 align-middle">({u.name})</span>
                                                                    )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex flex-wrap items-center gap-x-2 gap-y-1 mt-0.5">
                                                                    {isDonor && <span title={showValue ? "" : "Valor Oculto"} className="text-xs text-emerald-400/80 bg-emerald-950/30 px-1.5 py-0.5 rounded border border-emerald-900 inline-flex items-center whitespace-nowrap gap-1">{showValue ? `R$ ${donation.amount.toFixed(2)}` : <>R$<span className="blur-[2.5px] select-none opacity-80">99.99</span></>}</span>}
                                                                    {u.uid === user?.uid && <span className="text-[10px] text-purple-400 uppercase tracking-wider font-bold">Você</span>}
                                                                    {(isAdmin || isMe) && (
                                                                        <button onClick={() => handleOpenHistory(u)} className="bg-transparent border-none text-[10px] text-purple-400 uppercase tracking-wider font-bold hover:text-purple-300 transition ml-1 cursor-pointer" title="Ver Histórico">Histórico de Doações</button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                            
                                                            {showControls && (
                                                                <div className="flex gap-1 absolute right-2 top-2 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-900 p-1 rounded-lg border border-slate-700 shadow-xl z-20">
                                                                    {isDonor && (isAdmin || isMe) && (
                                                                        <>
                                                                            <button onClick={() => handleEditDonation(donation.id, donation.amount)} className="p-1.5 hover:bg-blue-600 text-blue-400 hover:text-white rounded transition" title="Editar Valor"><Icon name="pencil" className="w-4 h-4" /></button>
                                                                            <button onClick={() => handleDeleteDonation(donation.id)} className="p-1.5 hover:bg-amber-600 text-amber-400 hover:text-white rounded transition" title="Remover Doação (Mantém Usuário)"><Icon name="coins" className="w-4 h-4" /></button>
                                                                        </>
                                                                    )}
                                                                    {(isAdmin || isMe) && (
                                                                        <button onClick={() => window.location.href = `meu-perfil.html${isMe ? '' : '?uid=' + u.uid}`} className="p-1.5 hover:bg-purple-600 text-purple-400 hover:text-white rounded transition" title="EDITAR PERFIL"><Icon name="user-cog" className="w-4 h-4" /></button>
                                                                    )}
                                                                    {isAdmin && !isMe && (
                                                                        <button onClick={() => handleDeleteUser(u.uid)} className="p-1.5 hover:bg-red-600 text-red-400 hover:text-white rounded transition" title="EXCLUIR USUÁRIO PERMANENTEMENTE"><Icon name="user-x" className="w-4 h-4" /></button>
                                                                    )}
                                                                </div>
                                                            )}
                                                        </div>
                                                        </React.Fragment>
                                                    );
                                                })
                                            )
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="mt-8 relative">
                            {!user && (
                                <div className="absolute inset-0 z-20 flex flex-col items-center justify-center bg-slate-900/90 backdrop-blur-sm rounded-2xl border border-slate-800 p-6 text-center animate-fade-in">
                                    <div className="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 border border-slate-700 shadow-2xl">
                                        <Icon name="lock" className="w-10 h-10 text-slate-500" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-white mb-3 font-medieval tracking-wide">Acesso Restrito</h3>
                                    <p className="text-slate-400 text-base mb-8 max-w-md">
                                        Estas informações são confidenciais. Identifique-se para visualizar o endereço do servidor e acessar nossa comunidade.
                                    </p>
                                    <button onClick={() => setView('login')} className="px-8 py-3 bg-gradient-to-r from-purple-700 to-indigo-600 hover:from-purple-600 hover:to-indigo-500 text-white font-bold rounded-xl shadow-lg flex items-center gap-3 transition transform hover:scale-105 border border-purple-500/30">
                                        <Icon name="log-in" className="w-5 h-5" />
                                        ACESSAR PORTAL
                                    </button>
                                </div>
                            )}

                            <div className={`flex flex-col gap-6 transition-all duration-500 ${!user ? 'blur-md select-none pointer-events-none' : ''}`}>
                            <ModpackSection />
                            
                            <div className="grid md:grid-cols-2 gap-6">
                            {/* Discord Widget - SUBSTITUA O ID ABAIXO PELO ID DO SEU SERVIDOR */}
                            <div className="flex flex-col h-[600px] md:h-[600px] gap-3">
                                <div className="relative overflow-hidden rounded-2xl bg-[#2f3136] shadow-2xl border border-[#202225] flex-grow">
                                    <iframe 
                                        src="https://discord.com/widget?id=1454549534670852168&theme=dark" 
                                        width="100%" 
                                        height="100%" 
                                        allowTransparency="true" 
                                        frameBorder="0" 
                                        sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"
                                        title="Discord Widget"
                                    ></iframe>
                                </div>
                                <a href="https://discord.gg/acupula" target="_blank" rel="noopener noreferrer" className="w-full py-3 bg-[#5865F2] hover:bg-[#4752C4] text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all group border border-[#4752C4]">
                                    <Icon name="external-link" className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                    ABRIR NO APP / NAVEGADOR
                                </a>
                            </div>

                            {/* Terminal Server Info */}
                            <div className="relative overflow-hidden rounded-2xl bg-[#0c0c0c] border border-slate-800 p-0 shadow-2xl flex flex-col h-auto min-h-[600px] font-mono text-sm">
                                {/* Terminal Header */}
                                <div className="bg-[#1f1f1f] px-4 py-3 flex items-center gap-2 border-b border-[#333]">
                                    <div className="flex gap-2">
                                        <div className="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
                                        <div className="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
                                        <div className="w-3 h-3 rounded-full bg-[#27c93f]"></div>
                                    </div>
                                    <div className="flex-1 text-center text-slate-400 text-xs">root@acupula-server:~</div>
                                </div>
                                
                                {/* Terminal Body */}
                                <div className="p-4 sm:p-6 flex-grow space-y-4 text-slate-300 overflow-y-auto custom-scrollbar font-mono">
                                    <div>
                                        <p className="text-slate-500 mb-1"># Iniciando conexão segura...</p>
                                        <p><span className={isServerOnline ? "text-emerald-500" : "text-red-500"}>➜</span> <span className="text-blue-400">~</span> connect --secure <span className={isServerOnline ? "text-amber-400" : "text-red-400"}>{serverIp}</span></p>
                                    </div>

                                    <div className="space-y-1 opacity-80">
                                        <p>Resolving host...</p>
                                        <p>Connecting to port 35601...</p>
                                        {isServerOnline ? (
                                            <p className="text-emerald-500">Connection established!</p>
                                        ) : (
                                            <p className="text-red-500">Connection failed!</p>
                                        )}
                                    </div>

                                    <div className="py-4 border-y border-white/5 my-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-slate-400">STATUS DO SERVIDOR</span>
                                            <div className="flex items-center gap-2">
                                                {isAdmin && (
                                                    <label htmlFor="server-status-toggle" className="relative inline-flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={isServerOnline} onChange={() => handleUpdateServerStatus(!isServerOnline)} id="server-status-toggle" className="sr-only peer" />
                                                        <div className="w-9 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-600"></div>
                                                    </label>
                                                )}
                                                <span className={`${isServerOnline ? 'text-emerald-400 bg-emerald-950/30 border-emerald-900 animate-pulse' : 'text-red-400 bg-red-950/30 border-red-900'} px-2 py-0.5 rounded border text-xs`}>
                                                    ● {isServerOnline ? 'ONLINE' : 'OFFLINE'}
                                                </span>
                                            </div>
                                        </div>
                                        {isServerOnline ? (
                                            <>
                                                <div className="flex justify-between items-center">
                                                    <span className="text-slate-400">JOGADORES</span>
                                                    <span className="text-purple-400">{playerCount} / {maxHeroes}</span>
                                                </div>
                                                <div className="flex justify-between items-center mt-2">
                                                    <span className="text-slate-400">LATÊNCIA</span>
                                                    <span className="text-blue-400">14ms</span>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="text-center text-slate-500 text-xs pt-2">
                                                O servidor está OFFLINE.
                                            </div>
                                        )}
                                    </div>

                                    <div>
                                        <p className="mb-2"><span className={isServerOnline ? "text-emerald-500" : "text-red-500"}>➜</span> <span className="text-blue-400">~</span> {isEditingIp ? 'Salvar endereço:' : 'Copiar endereço:'}</p>
                                        
                                        {isEditingIp && isAdmin ? (
                                            <div className="flex items-center gap-2">
                                                <input 
                                                    type="text"
                                                    value={newIp}
                                                    onChange={(e) => setNewIp(e.target.value)}
                                                    className={`w-full bg-slate-950 border rounded p-2 font-bold tracking-wider outline-none ${isServerOnline ? 'border-amber-500 text-amber-400' : 'border-red-500 text-red-400'}`}
                                                />
                                                <button onClick={onSaveIp} className="p-2 bg-emerald-600 hover:bg-emerald-500 rounded" title="Salvar"><Icon name="check" className="w-4 h-4 text-white" /></button>
                                                <button onClick={() => setIsEditingIp(false)} className="p-2 bg-red-600 hover:bg-red-500 rounded" title="Cancelar"><Icon name="x" className="w-4 h-4 text-white" /></button>
                                            </div>
                                        ) : (
                                            <div className="relative group">
                                                <button 
                                                    onClick={handleCopyIp}
                                                    className={`w-full bg-slate-900 hover:bg-slate-800 border border-slate-700 text-left p-4 rounded transition-all flex items-center justify-between ${isServerOnline ? 'hover:border-emerald-500' : 'hover:border-red-500'}`}
                                                >
                                                    <span className={`font-bold tracking-wider ${isServerOnline ? 'text-emerald-400' : 'text-red-400'}`}>{serverIp}</span>
                                                    {ipCopied ? <Icon name="check" className="w-4 h-4 text-emerald-500" /> : <Icon name="copy" className="w-4 h-4 text-slate-500 group-hover:text-white" />}
                                                </button>
                                                {isAdmin && (
                                                    <button onClick={() => setIsEditingIp(true)} className="absolute right-12 top-1/2 -translate-y-1/2 p-1.5 text-slate-500 hover:text-white hover:bg-slate-700 rounded-md opacity-0 group-hover:opacity-100 transition-opacity" title="Editar IP">
                                                        <Icon name="pencil" className="w-4 h-4" />
                                                    </button>
                                                )}
                                            </div>
                                        )}
                                        
                                        {ipCopied && <p className="text-emerald-500 text-xs mt-2 animate-fade-in">> Endereço copiado com sucesso!</p>}
                                    </div>
                                    
                                    <div className="pt-4 animate-pulse">
                                        <span className={isServerOnline ? "text-emerald-500" : "text-red-500"}>➜</span> <span className="text-blue-400">~</span> <span className="w-2 h-4 bg-slate-500 inline-block align-middle"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
                        </div>
                    </div>
                </main>
            );
        };

        // 4. Main App Container
        function iniciarApp() {
            const app = window.firebaseApp;
            const auth = window.firebaseAuth.getAuth(app);
            const db = window.firebaseFirestore.getFirestore(app);
            
            const appId = 'cupula-server-v1'; 
            const SERVER_GOAL = 60.00;
            const MAX_HEROES = 16; 
            const ADMIN_EMAIL = "cupulasmp@gmail.com"; 
            const VALID_ACCESS_CODES = ["96GD-HWXX-S9VC", "YOJC-6WAJ-94DF", "JPH2-J7BS-MQBC", "D4KX-3V7H-2R6D", "3029"];
            const { onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail } = window.firebaseAuth;
            const { collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, doc, setDoc, getDoc, where, getDocs, deleteDoc, writeBatch, updateDoc, collectionGroup } = window.firebaseFirestore;

            function getDynamicCycleDates(referenceDate) {
                const now = new Date();
                const ref = new Date(referenceDate);
                now.setHours(0, 0, 0, 0);
                ref.setHours(0, 0, 0, 0);

                if (ref > now) {
                    const diffTime = ref - now;
                    const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return { lastResetDate: new Date(0), nextResetDate: ref, daysRemaining };
                }

                const resetDay = ref.getUTCDate(); 
                let lastResetDate = new Date();
                let nextResetDate = new Date();
                if (now.getDate() >= resetDay) {
                    lastResetDate.setDate(resetDay); lastResetDate.setHours(0, 0, 0, 0);
                    nextResetDate.setMonth(now.getMonth() + 1); nextResetDate.setDate(resetDay); nextResetDate.setHours(0, 0, 0, 0);
                } else {
                    lastResetDate.setMonth(now.getMonth() - 1); lastResetDate.setDate(resetDay); lastResetDate.setHours(0, 0, 0, 0);
                    nextResetDate.setDate(resetDay); nextResetDate.setHours(0, 0, 0, 0);
                }
                const diffTime = nextResetDate - now;
                const daysRemaining = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24))); 
                return { lastResetDate, nextResetDate, daysRemaining };
            }

            function App() {
                const [accessGranted, setAccessGranted] = React.useState(false);
                const [accessCodeInput, setAccessCodeInput] = React.useState('');
                const [user, setUser] = React.useState(null);
                const [loading, setLoading] = React.useState(true);

                // Verifica URL para saber se deve abrir login ou registro
                const params = new URLSearchParams(window.location.search);
                const mode = params.get('mode');

                // Define a tela inicial baseada no modo
                let startView = 'home';
                if (mode === 'login') startView = 'login';
                if (mode === 'register') startView = 'register';

                const [view, setView] = React.useState(startView);
                const [totalCollected, setTotalCollected] = React.useState(0);
                const [donations, setDonations] = React.useState([]);
                const [allUsers, setAllUsers] = React.useState([]);
                const [historyModal, setHistoryModal] = React.useState({ open: false, user: null, list: [], loading: false });
                const [cycleStartDate, setCycleStartDate] = React.useState(new Date()); 
                const [isServerOnline, setIsServerOnline] = React.useState(true);
                const [serverIp, setServerIp] = React.useState('jogar.acupula.com.br');
                
                const [showPixModal, setShowPixModal] = React.useState(false);
                const [pixCopied, setPixCopied] = React.useState(false);
                const [isSubmitting, setIsSubmitting] = React.useState(false);
                const [donationAmount, setDonationAmount] = React.useState(2);
                const [error, setError] = React.useState('');
                
                const [authForm, setAuthForm] = React.useState({
                    email: '', 
                    password: '', 
                    confirmPassword: '', 
                    name: '', 
                    minecraftNick: '', 
                    birthDate: '', 
                    selectedAvatar: 'villager'
                });

                const [newCycleDate, setNewCycleDate] = React.useState('');

                const { lastResetDate, nextResetDate, daysRemaining } = getDynamicCycleDates(cycleStartDate);
                const isAdmin = user && user.email === ADMIN_EMAIL;
                const playerCount = allUsers.filter(u => u.email !== ADMIN_EMAIL).length;
                const isHeroesRoomFull = playerCount >= MAX_HEROES;
                const hasDonated = user ? donations.some(d => d.userId === user.uid) : false;
                const isGoalReached = totalCollected >= SERVER_GOAL;
                const nextResetFormatted = nextResetDate.toLocaleDateString('pt-PT', { day: 'numeric', month: 'long', year: 'numeric' });

                React.useEffect(() => {
                    if (user && (view === 'login' || view === 'register')) {
                        setView('home');
                        setIsSubmitting(false);
                    }
                }, [user, view]);

                React.useEffect(() => {
                    const savedAccess = localStorage.getItem('cupula_access_granted');
                    if (savedAccess === 'true') setAccessGranted(true);

                    const unsubscribeAuth = onAuthStateChanged(auth, async (currentUser) => {
                        if (currentUser) {
                            try {
                                // A lógica de criação de perfil agora está no cabeçalho (sistema-cupula.js)
                                // Aqui, apenas lemos os dados existentes.
                                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data');
                                const userDoc = await getDoc(userDocRef);
                                if (userDoc.exists()) {
                                    setUser({ ...currentUser, ...userDoc.data() });
                                } else {
                                    setUser(currentUser); // Se não existir, o cabeçalho irá criar e o onSnapshot atualizará.
                                }
                            } catch (e) { setUser(currentUser); }
                        } else {
                            setUser(null);
                        }
                        setLoading(false);
                    });

                    const settingsRef = doc(db, 'artifacts', appId, 'public', 'settings');
                    const unsubscribeSettings = onSnapshot(settingsRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.cycleStartDate) {
                                const savedDate = new Date(data.cycleStartDate.seconds * 1000);
                                const userOffset = savedDate.getTimezoneOffset() * 60000;
                                const adjustedDate = new Date(savedDate.getTime() + userOffset);
                                setCycleStartDate(savedDate);
                                setNewCycleDate(adjustedDate.toISOString().slice(0, 10));
                            }
                            // Ler o status do servidor
                            if (typeof data.isServerOnline === 'boolean') {
                                setIsServerOnline(data.isServerOnline);
                            }
                            if (data.serverIp) {
                                setServerIp(data.serverIp);
                            }
                        } else if (!docSnap.exists()) {
                            setDoc(settingsRef, { cycleStartDate: new Date(), isServerOnline: true, serverIp: 'jogar.acupula.com.br' }, { merge: true });
                        }
                    });

                    return () => { unsubscribeAuth(); unsubscribeSettings(); };
                }, []);

                // Listener para todos os usuários (Sala dos Heróis)
                React.useEffect(() => {
                    const qUsers = query(collectionGroup(db, 'profile'));
                    const unsubscribeUsers = onSnapshot(qUsers, (snapshot) => {
                        const usersList = snapshot.docs.map(doc => ({ uid: doc.ref.parent.parent.id, ...doc.data() }));
                        setAllUsers(usersList);
                    });
                    return () => unsubscribeUsers();
                }, []);

                React.useEffect(() => {
                    const { lastResetDate: corte } = getDynamicCycleDates(cycleStartDate);
                    const q = query(
                        collection(db, 'artifacts', appId, 'public', 'data', 'donations'), 
                        where('timestamp', '>=', corte), 
                        orderBy('timestamp', 'desc')
                    );
                    const unsubscribeDonations = onSnapshot(q, (snapshot) => {
                        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDonations(docs);
                        setTotalCollected(docs.reduce((acc, curr) => acc + Number(curr.amount), 0));
                    });
                    return () => unsubscribeDonations();
                }, [cycleStartDate]);

                const handleUpdateServerStatus = async (newStatus) => {
                    const settingsRef = doc(db, 'artifacts', appId, 'public', 'settings');
                    try {
                        await setDoc(settingsRef, { isServerOnline: newStatus }, { merge: true });
                    } catch (error) {
                        console.error("Erro ao atualizar status do servidor: ", error);
                    }
                };

                const handleUpdateServerIp = async (newIp) => {
                    const settingsRef = doc(db, 'artifacts', appId, 'public', 'settings');
                    try {
                        await setDoc(settingsRef, { serverIp: newIp }, { merge: true });
                    } catch (error) {
                        console.error("Erro ao atualizar IP do servidor: ", error);
                    }
                };

                const handleAuth = async (e, type, isPirate = false, agreedToTerms = false) => {
                    e.preventDefault();
                    if (isSubmitting) return;
                    setIsSubmitting(true);
                    setError('');
                    try {
                        if (type === 'register') {
                            if (!agreedToTerms) {
                                throw new Error('Você precisa aceitar os Termos de Serviço para se registrar.');
                            }
                            
                            if (playerCount >= MAX_HEROES) {
                                throw new Error('Não é possível criar a conta por ter o máximo de jogadores atingido. Entre em contato com um admin.');
                            }

                            if (authForm.password !== authForm.confirmPassword) {
                                throw new Error('As senhas não coincidem.');
                            }
                            if (authForm.password.length < 6) {
                                throw new Error('A senha deve ter pelo menos 6 caracteres.');
                            }
                            if (!authForm.birthDate) throw new Error('Data de nascimento é obrigatória.');
                            
                            if (!authForm.name) throw new Error('Nome real é obrigatório.');
                            
                            const effectiveNick = authForm.minecraftNick;
                            const displayName = authForm.name;

                            if (!effectiveNick && authForm.email !== "cupulasmp@gmail.com") {
                                throw new Error('Nick do Minecraft é obrigatório.');
                            }

                            // Validação do Nick do Minecraft
                            if (!isPirate && effectiveNick && authForm.email !== ADMIN_EMAIL) {
                                const nickExists = await checkMinecraftNickExists(authForm.minecraftNick);
                                if (!nickExists) {
                                    throw new Error('O nick do Minecraft informado não existe ou está incorreto.');
                                }
                            }

                            const cred = await createUserWithEmailAndPassword(auth, authForm.email, authForm.password);
                            
                            await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'data'), {
                                name: displayName, 
                                minecraftNick: effectiveNick, 
                                birthDate: authForm.birthDate, 
                                avatarId: authForm.selectedAvatar, 
                                role: 'user', 
                                email: authForm.email,
                                isOriginal: !isPirate,
                                whitelistStatus: 'pending',
                                createdAt: serverTimestamp()
                            });
                            
                            await updateProfile(cred.user, { displayName: displayName });
                        } else {
                            const loginIdentifier = authForm.email.trim();
                            let userEmail = loginIdentifier;

                            // Se não parecer um email, busca pelo Nick do Minecraft
                            if (!loginIdentifier.includes('@')) {
                                const profileQuery = query(collectionGroup(db, 'profile'), where('minecraftNick', '==', loginIdentifier));
                                const querySnapshot = await getDocs(profileQuery);

                                if (querySnapshot.empty) {
                                    throw new Error('Credenciais inválidas.');
                                }
                                
                                userEmail = querySnapshot.docs[0].data().email;
                                if (!userEmail) {
                                    throw new Error('Conta encontrada, mas sem email associado. Contate o suporte.');
                                }
                            }
                            
                            await signInWithEmailAndPassword(auth, userEmail, authForm.password);
                        }
                    } catch (err) {
                        let errorMessage;
                        if (err.message.includes('Minecraft')) {
                            errorMessage = err.message;
                        } else if (type === 'login') {
                            errorMessage = "Credenciais inválidas.";
                        } else { // Erros de Registro
                            switch (err.code) {
                                case 'auth/email-already-in-use':
                                    errorMessage = 'Este email já está em uso por outra conta.';
                                    break;
                                case 'auth/invalid-email':
                                    errorMessage = 'O formato do email fornecido é inválido.';
                                    break;
                                case 'auth/weak-password':
                                    errorMessage = 'A senha é muito fraca. Tente uma mais forte.';
                                    break;
                                default:
                                    errorMessage = err.message || "Ocorreu um erro durante o registro.";
                            }
                        }
                        setError(errorMessage);
                        setIsSubmitting(false);
                    }
                };

                const handleForgotPassword = async (email) => {
                    if (!email) {
                        setError("Por favor, digite seu e-mail no campo acima para recuperar a senha.");
                        return;
                    }
                    try {
                        await sendPasswordResetEmail(auth, email);
                        alert(`Um e-mail de recuperação foi enviado para ${email}. Verifique sua caixa de entrada (e spam).`);
                    } catch (err) {
                        setError("Erro ao enviar e-mail: " + err.message);
                    }
                };

                const handleAccessCode = (e) => {
                    e.preventDefault();
                    if (VALID_ACCESS_CODES.includes(accessCodeInput.trim().toUpperCase())) {
                        setAccessGranted(true);
                        localStorage.setItem('cupula_access_granted', 'true');
                    } else { setError('Código inválido.'); }
                };

                const handleOpenPixModal = () => {
                    if (!isServerOnline) {
                        setError('Não é possível contribuir enquanto o servidor está offline.');
                        return;
                    }
                    const remaining = SERVER_GOAL - totalCollected;
                    const val = parseFloat(donationAmount);
                    // Removida verificação de sala cheia para doação, pois agora todos estão na sala.
                    if (val < 2) { setError('Mínimo R$ 2,00'); return; }
                    if (totalCollected >= SERVER_GOAL) { setError('Meta atingida!'); return; }
                    if (val > remaining && remaining > 0) { setError(`Máximo: R$ ${remaining.toFixed(2)}`); return; }
                    setError('');
                    setShowPixModal(true);
                };

                const handleCopyPix = async () => {
                    try {
                        await navigator.clipboard.writeText("chave-pix-exemplo@banco.com");
                        setPixCopied(true);
                        setTimeout(() => setPixCopied(false), 2000);
                    } catch (err) { console.error(err); }
                };

                const handleConfirmDonation = async () => {
                    if (!user || isSubmitting) return;
                    setIsSubmitting(true);
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'donations'), {
                            userId: user.uid, userName: user.name || user.displayName, userAvatar: user.avatarId || 'warrior',
                            amount: parseFloat(donationAmount), isAnonymous: false, timestamp: serverTimestamp()
                        });
                        setShowPixModal(false);
                        setView('success');
                        setTimeout(() => { setView('home'); setIsSubmitting(false); }, 3000);
                    } catch (err) { 
                        setError("Erro: " + err.message); 
                        setIsSubmitting(false); 
                        setShowPixModal(false);
                    }
                };
                
                const handleUpdateCycle = async () => {
                    if (!newCycleDate) return;
                    const parts = newCycleDate.split('-');
                    const dateObj = new Date(parts[0], parts[1]-1, parts[2]);
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'settings'), { cycleStartDate: dateObj }, { merge: true });
                    alert('Ciclo atualizado!');
                };

                const handleAdminReset = async () => {
                    if (!user) return;
                    if (user.email.trim().toLowerCase() !== ADMIN_EMAIL.trim().toLowerCase()) {
                        alert(`Acesso Negado.\n\nLogado como: ${user.email}\nAdmin esperado: ${ADMIN_EMAIL}`);
                        return;
                    }
                    if (!confirm("⚠️ ATENÇÃO: Isso vai apagar TODAS as doações (dinheiro) para iniciar um novo mês.\n\nOs usuários cadastrados SERÃO MANTIDOS.\n\nConfirmar reset do ciclo?")) return;
                    setIsSubmitting(true);
                    try {
                        const batches = [];
                        let batch = writeBatch(db);
                        let operationCounter = 0;

                        // 1. Buscar APENAS Doações (Mantém usuários)
                        const qDonations = collection(db, 'artifacts', appId, 'public', 'data', 'donations');
                        const snapshotDonations = await getDocs(qDonations);

                        if (snapshotDonations.empty) {
                            alert("O banco de dados já está vazio.");
                        } else {
                            snapshotDonations.docs.forEach((doc, index) => {
                                batch.delete(doc.ref);
                                operationCounter++;
                                if (operationCounter >= 499 || index === snapshotDonations.docs.length - 1) {
                                    batches.push(batch.commit());
                                    batch = writeBatch(db);
                                    operationCounter = 0;
                                }
                            });
                            await Promise.all(batches);
                            alert("Sucesso! Todas as doações foram apagadas.");
                        }
                    } catch (err) { alert("Erro ao resetar: " + err.message); } finally { setIsSubmitting(false); }
                };

                const handleUpdateAvatar = async (userId, newAvatarId) => {
                    try {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data'), { avatarId: newAvatarId });
                    } catch (err) {
                        alert("Erro ao atualizar avatar: " + err.message);
                    }
                };

                const handleDeleteUser = async (userId) => {
                    if (confirm("⚠️ TEM CERTEZA?\n\nIsso vai excluir PERMANENTEMENTE a conta deste usuário da Sala de Heróis.\nEssa ação não pode ser desfeita.")) {
                        try {
                            await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data'));
                        } catch (err) { alert("Erro ao excluir usuário: " + err.message); }
                    }
                };

                const handleDeleteDonation = async (id) => {
                    if (confirm("Apagar esta doação?")) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', id));
                    }
                };

                const handleEditDonation = async (id, currentVal) => {
                    const newVal = prompt("Novo valor:", currentVal);
                    if (newVal && !isNaN(newVal)) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'donations', id), { amount: parseFloat(newVal) });
                    }
                };

                const handleOpenHistory = async (targetUser) => {
                    setHistoryModal({ open: true, user: targetUser, list: [], loading: true });
                    try {
                        const q = query(
                            collection(db, 'artifacts', appId, 'public', 'data', 'donations'),
                            where('userId', '==', targetUser.uid)
                        );
                        const snapshot = await getDocs(q);
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        
                        // Ordena por data (mais recente primeiro) via código para evitar erro de índice no banco
                        data.sort((a, b) => {
                            const timeA = a.timestamp ? a.timestamp.seconds : 0;
                            const timeB = b.timestamp ? b.timestamp.seconds : 0;
                            return timeB - timeA;
                        });
                        
                        setHistoryModal({ open: true, user: targetUser, list: data, loading: false });
                    } catch (err) {
                        console.error(err);
                        setHistoryModal(prev => ({ ...prev, loading: false }));
                    }
                };

                // TELA DE ACESSO RESTRITO (MUDANÇAS APLICADAS AQUI)
                if (!accessGranted) return (
                    <div className="min-h-screen bg-[#2B2933] flex items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                        <div className="max-w-md w-full bg-slate-900/80 border border-purple-500/30 rounded-2xl p-8 backdrop-blur-md relative z-10 animate-fade-in text-center">
                            <div className="mb-6 flex justify-center"><div className="p-4 bg-purple-500/10 rounded-full border border-purple-500/30"><Icon name="lock" className="w-10 h-10 text-purple-400" /></div></div>
                            <h3 className="text-2xl font-bold text-white mb-2 uppercase tracking-widest">Área Restrita</h3>
                            <p className="text-slate-400 text-sm mb-6">Digite o código recebido por e-mail.</p>
                            <form onSubmit={handleAccessCode} className="flex flex-col gap-4">
                                <input type="text" value={accessCodeInput} onChange={(e) => setAccessCodeInput(e.target.value)} placeholder="CÓDIGO DE ACESSO" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-4 text-center text-white placeholder-slate-600 focus:border-purple-500 outline-none uppercase font-mono text-lg tracking-wider" />
                                {error && <div className="text-red-400 text-sm">{error}</div>}
                                <button type="submit" className="w-full bg-gradient-to-r from-purple-700 to-indigo-600 hover:from-purple-600 text-white font-bold py-4 rounded-lg shadow-lg flex items-center justify-center gap-2">ACESSAR <Icon name="arrow-right" className="w-4 h-4" /></button>
                            </form>
                        </div>
                    </div>
                );

                if (loading) return <div className="h-screen flex items-center justify-center text-amber-500 bg-[#2B2933]"><Icon name="loader-2" className="w-10 h-10 animate-spin" /></div>;

                return (
                    <div className="flex flex-col flex-grow">
                        {/* NOTA: O Navbar e Footer agora estão fora deste componente, sendo renderizados pelo sistema compartilhado. */}

                        {view === 'success' ? (
                            <div className="flex-grow flex flex-col items-center justify-center animate-fade-in p-4 text-center">
                                <div className="w-32 h-32 bg-emerald-500/10 rounded-full flex items-center justify-center mb-6 animate-bounce border border-emerald-500/30">
                                    <Icon name="check-circle-2" className="w-20 h-20 text-emerald-400" />
                                </div>
                                <h1 className="text-5xl font-bold text-emerald-400 mb-4 font-medieval tracking-wider drop-shadow-lg">UHHUUU!</h1>
                                <p className="text-2xl text-emerald-100 max-w-lg">Muito Obrigado Pela Sua Ajuda.</p>
                            </div>
                        ) : (view === 'login' || view === 'register') ? (
                            <AuthScreen 
                                view={view} 
                                setView={setView} 
                                handleLogin={(e) => handleAuth(e, 'login', false, false)} 
                                handleRegister={(e, isPirate, agreed) => handleAuth(e, 'register', isPirate, agreed)} 
                                handleForgotPassword={handleForgotPassword}
                                isSubmitting={isSubmitting} 
                                error={error}
                                formState={authForm}
                                setFormState={setAuthForm}
                            />
                        ) : (
                            <DashboardScreen 
                                user={user}
                                donations={donations}
                                allUsers={allUsers}
                                playerCount={playerCount}
                                totalCollected={totalCollected}
                                serverGoal={SERVER_GOAL}
                                maxHeroes={MAX_HEROES}
                                daysRemaining={daysRemaining}
                                nextResetFormatted={nextResetFormatted}
                                handleOpenPixModal={handleOpenPixModal}
                                donationAmount={donationAmount}
                                setDonationAmount={setDonationAmount}
                                error={error}
                                isAdmin={isAdmin}
                                handleEditDonation={handleEditDonation}
                                handleDeleteDonation={handleDeleteDonation}
                                handleDeleteUser={handleDeleteUser}
                                handleUpdateAvatar={handleUpdateAvatar}
                                setView={setView}
                                isHeroesRoomFull={isHeroesRoomFull}
                                hasDonated={hasDonated}
                                isGoalReached={isGoalReached}
                                handleOpenHistory={handleOpenHistory}
                                adminEmail={ADMIN_EMAIL}
                                isServerOnline={isServerOnline}
                                handleUpdateServerStatus={handleUpdateServerStatus}
                                serverIp={serverIp}
                                handleUpdateServerIp={handleUpdateServerIp}
                            />
                        )}

                        {showPixModal && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                                <div className="bg-slate-900/90 backdrop-blur-md border border-amber-500/50 rounded-2xl max-w-md w-full p-6 shadow-2xl relative">
                                    <div className="absolute top-4 right-4 flex items-center gap-2">
                                        <div className="relative group">
                                            <button className="text-slate-400 hover:text-amber-400 transition"><Icon name="help-circle" className="w-6 h-6" /></button>
                                            <div className="absolute right-0 top-8 w-64 bg-slate-950 border border-amber-500/50 p-3 rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition pointer-events-none z-50 text-xs text-amber-200 text-center">
                                                <p><strong>⚠️ IMPORTANTE:</strong> O sistema não detecta o pagamento automaticamente.</p>
                                                <p className="mt-1">Após o Pix, clique no botão abaixo para confirmar.</p>
                                            </div>
                                        </div>
                                        <button onClick={() => setShowPixModal(false)} className="text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button>
                                    </div>
                                    <div className="text-center mb-6">
                                        <div className="w-16 h-16 bg-amber-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-amber-500/30"><Icon name="qr-code" className="w-8 h-8 text-amber-500" /></div>
                                        <h3 className="text-2xl font-bold text-white mb-1">Pagamento via Pix</h3>
                                        <p className="text-slate-400 text-sm">Valor: <span className="text-amber-400 font-bold text-lg">R$ {parseFloat(donationAmount).toFixed(2)}</span></p>
                                    </div>
                                    <div className="bg-white p-4 rounded-lg mb-6 flex justify-center">
                                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=00020126360014BR.GOV.BCB.PIX0114+551199999999952040000530398654041.005802BR5925Nome%20do%20Beneficiario6009Sao%20Paulo62070503***63041234" alt="QR Code" className="w-48 h-48 opacity-90" />
                                    </div>
                                    <div className="bg-slate-950 rounded p-4 mb-6 border border-slate-800 flex items-center gap-2 relative">
                                        <code className="flex-1 text-center text-sm font-mono text-purple-300 truncate">chave-pix-exemplo@banco.com</code>
                                        <button onClick={handleCopyPix} className="text-slate-400 hover:text-white transition" title="Copiar chave Pix">
                                            <Icon name="copy" className="w-4 h-4" />
                                        </button>
                                        {pixCopied && <div className="absolute inset-0 flex items-center justify-center bg-slate-950 animate-fade-out-up pointer-events-none rounded">
                                            <span className="text-emerald-400 font-bold flex items-center gap-2"><Icon name="check" className="w-4 h-4" /> COPIADO!</span>
                                        </div>}
                                    </div>
                                    <button onClick={handleConfirmDonation} disabled={isSubmitting} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2">
                                        {isSubmitting ? 'CONFIRMANDO...' : 'JÁ FIZ O PAGAMENTO'} <Icon name="check-circle" className="w-5 h-5" />
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* MODAL DE HISTÓRICO */}
                        {historyModal.open && (
                            <div className="fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                                <div className="bg-slate-900/90 backdrop-blur-md border border-slate-700 rounded-2xl max-w-md w-full p-4 sm:p-6 shadow-2xl relative">
                                    <button onClick={() => setHistoryModal({ ...historyModal, open: false })} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="x" className="w-6 h-6" /></button>
                                    
                                    <div className="text-center mb-6">
                                        <div className="w-12 h-12 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-3 border border-slate-700">
                                            <Icon name="history" className="w-6 h-6 text-purple-400" />
                                        </div>
                                        <div className="flex items-center justify-center gap-2">
                                            <h3 className="text-xl font-bold text-white">Histórico de Doações</h3>
                                            <button onClick={() => handleOpenHistory(historyModal.user)} className="p-1 text-slate-500 hover:text-white transition" title="Atualizar Lista"><Icon name="refresh-cw" className="w-4 h-4" /></button>
                                        </div>
                                        <p className="text-slate-400 text-sm">
                                            {historyModal.loading ? "Carregando..." : <span className="text-emerald-400 font-bold">{historyModal.list.length} contribuições totais</span>}
                                        </p>
                                    </div>

                                    <div className="space-y-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-2">
                                        {historyModal.loading ? (
                                            <div className="flex justify-center py-4"><Icon name="loader-2" className="w-6 h-6 animate-spin text-purple-500" /></div>
                                        ) : historyModal.list.length === 0 ? (
                                            <p className="text-center text-slate-500 py-4">Nenhum registro encontrado.</p>
                                        ) : (
                                            historyModal.list.map((item, idx) => {
                                                const date = item.timestamp ? new Date(item.timestamp.seconds * 1000) : new Date();
                                                const dateStr = date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                                                const canSeeValue = isAdmin || (user && user.uid === historyModal.user.uid);
                                                
                                                return (
                                                    <div key={item.id} className="flex justify-between items-center p-3 bg-slate-950 rounded-lg border border-slate-800 hover:border-slate-700 transition">
                                                        <div className="flex items-center gap-3">
                                                            <div className="text-xs font-mono text-slate-600 w-6">#{historyModal.list.length - idx}</div>
                                                            <div className="text-sm text-slate-300 capitalize flex items-center gap-2 whitespace-nowrap"><Icon name="calendar" className="w-3 h-3 text-slate-500" /> {dateStr}</div>
                                                        </div>
                                                        <div className="text-sm font-bold font-mono whitespace-nowrap">
                                                            {canSeeValue ? (
                                                                <span className="text-emerald-400">R$ {item.amount.toFixed(2)}</span>
                                                            ) : (
                                                                <span className="text-slate-600 blur-[2px] select-none" title="Valor Oculto">R$ 99.99</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {isAdmin && view === 'home' && (
                            <div className="fixed bottom-4 right-4 z-50 flex items-end gap-2 flex-col opacity-90 hover:opacity-100 transition">
                                <div className="bg-slate-900/90 backdrop-blur-md border border-slate-700 p-3 rounded-lg shadow-xl mb-2 flex flex-col gap-2">
                                    <label className="text-[10px] text-slate-400 font-bold uppercase">📅 Próximo Pagamento</label>
                                    <div className="flex gap-2">
                                        <input type="date" value={newCycleDate} onChange={(e) => setNewCycleDate(e.target.value)} className="bg-slate-800 border border-slate-600 rounded p-1 text-center text-white text-xs" />
                                        <button onClick={handleUpdateCycle} className="bg-indigo-600 text-white px-2 rounded text-xs hover:bg-indigo-500">OK</button>
                                    </div>
                                    <div className="h-px bg-slate-700 my-1"></div>
                                    <button onClick={handleAdminReset} disabled={isSubmitting} className="bg-red-900/50 hover:bg-red-600 border border-red-500/30 text-red-200 hover:text-white px-3 py-2 rounded text-xs font-bold flex items-center justify-center gap-2 transition">
                                        <Icon name="trash-2" className="w-3 h-3" /> ZERAR TODAS AS DOAÇÕES
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<App />);
        }
    </script>
</body>
</html>