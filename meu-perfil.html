<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil - A Cúpula</title>
    
      <link rel="icon" href="favicon/logo.ico">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="nicepage.css" media="screen">
    <link rel="stylesheet" href="Portal.css" media="screen">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #2B2933; font-family: 'Montserrat', 'Inter', sans-serif; color: #e2e8f0; }
        .font-medieval { font-family: 'Cinzel', serif; }
        .bg-pattern { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); opacity: 0.05; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <div id="shared-header"></div>

    <div id="root" class="flex-grow flex flex-col"></div>

    <div id="shared-footer"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAOZK0kvixerSJSsf0EHob7suL5dBOKdn8",
            authDomain: "acupula.firebaseapp.com",
            projectId: "acupula",
            storageBucket: "acupula.firebasestorage.app",
            messagingSenderId: "268988769992",
            appId: "1:268988769992:web:c642eb669566b6230627fd"
        };

        const app = initializeApp(firebaseConfig);
        window.firebaseAuth = { getAuth, onAuthStateChanged, updatePassword, updateProfile, signOut };
        window.firebaseFirestore = { getFirestore, doc, getDoc, updateDoc, onSnapshot, setDoc, serverTimestamp };
        
        window.onSharedComponentsReady = window.onSharedComponentsReady || [];
        window.onSharedComponentsReady.push(() => {
            window.renderSharedComponents('perfil');
        });
    </script>

    <script src="sistema-cupula.js" type="text/babel"></script>

    <script type="text/babel">
        const checkMinecraftNickExists = async (nick) => {
            if (!nick) return false;
            try {
                const response = await fetch(`https://playerdb.co/api/player/minecraft/${nick}`);
                const data = await response.json();
                return data.success === true;
            } catch (error) {
                console.warn("Erro na verificação do nick:", error);
                return true;
            }
        };

        const AVATARS = [
            { id: 'villager', icon: 'user', label: 'Aldeão', color: 'text-emerald-600' },
            { id: 'king', icon: 'crown', label: 'Nobre', color: 'text-amber-500' },
            { id: 'mage', icon: 'wand-2', label: 'Mago', color: 'text-purple-500' },
            { id: 'rogue', icon: 'ghost', label: 'Ladino', color: 'text-emerald-500' },
            { id: 'archer', icon: 'target', label: 'Arqueiro', color: 'text-lime-500' },
            { id: 'barbarian', icon: 'axe', label: 'Bárbaro', color: 'text-orange-500' },
            { id: 'cleric', icon: 'heart-pulse', label: 'Clérigo', color: 'text-pink-500' },
            { id: 'druid', icon: 'leaf', label: 'Druida', color: 'text-green-500' },
            { id: 'paladin', icon: 'shield-check', label: 'Paladino', color: 'text-sky-500' },
            { id: 'blacksmith', icon: 'hammer', label: 'Ferreiro', color: 'text-gray-400' },
            { id: 'bard', icon: 'music', label: 'Bardo', color: 'text-yellow-300' },
            { id: 'merchant', icon: 'coins', label: 'Mercador', color: 'text-yellow-600' },
            { id: 'alchemist', icon: 'flask-conical', label: 'Alquimista', color: 'text-teal-400' },
            { id: 'hunter', icon: 'crosshair', label: 'Caçador', color: 'text-green-700' },
            { id: 'assassin', icon: 'sword', label: 'Assassino', color: 'text-slate-800' },
            { id: 'monk', icon: 'hand', label: 'Monge', color: 'text-orange-300' },
            { id: 'warlock', icon: 'flame', label: 'Bruxo', color: 'text-purple-800' },
            { id: 'necromancer', icon: 'skull', label: 'Necromante', color: 'text-zinc-500' },
            { id: 'explorer', icon: 'compass', label: 'Explorador', color: 'text-blue-400' },
            { id: 'miner', icon: 'pickaxe', label: 'Minerador', color: 'text-stone-400' },
            { id: 'builder', icon: 'hammer', label: 'Construtor', color: 'text-yellow-700' },
            { id: 'engineer', icon: 'wrench', label: 'Engenheiro', color: 'text-red-400' },
            { id: 'farmer', icon: 'wheat', label: 'Fazendeiro', color: 'text-lime-600' },
            { id: 'chef', icon: 'utensils', label: 'Cozinheiro', color: 'text-white' },
            { id: 'pirate', icon: 'anchor', label: 'Pirata', color: 'text-blue-800' },
            { id: 'ninja', icon: 'wind', label: 'Ninja', color: 'text-black' },
            { id: 'samurai', icon: 'sword', label: 'Samurai', color: 'text-red-700' },
            { id: 'viking', icon: 'axe', label: 'Viking', color: 'text-blue-300' },
            { id: 'guard', icon: 'shield', label: 'Guarda', color: 'text-slate-500' },
            { id: 'warrior', icon: 'sword', label: 'Guerreiro', color: 'text-red-500' },
        ];

        const Icon = ({ name, className }) => {
            const elementRef = React.useRef(null);
            React.useEffect(() => {
                if (window.lucide && elementRef.current) {
                    elementRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.className = className;
                    elementRef.current.appendChild(i);
                    window.lucide.createIcons({ root: elementRef.current });
                }
            }, [name, className]);
            return <span ref={elementRef} style={{ display: 'contents' }}></span>;
        };

        function ProfileApp() {
            const [user, setUser] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [saving, setSaving] = React.useState(false);
            const [targetUid, setTargetUid] = React.useState(null);
            const [isEditingOther, setIsEditingOther] = React.useState(false);
            const [message, setMessage] = React.useState({ type: '', text: '' });
            
            const [isPirate, setIsPirate] = React.useState(true);
            const [nickStatus, setNickStatus] = React.useState('idle');

            const [formData, setFormData] = React.useState({
                name: '',
                minecraftNick: '',
                birthDate: '',
                avatarId: 'villager',
                newPassword: '',
                confirmPassword: ''
            });

            const auth = window.firebaseAuth.getAuth();
            const db = window.firebaseFirestore.getFirestore();
            const appId = 'cupula-server-v1';
            const ADMIN_EMAIL = "cupulasmp@gmail.com";

            React.useEffect(() => {
                const unsubscribe = window.firebaseAuth.onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        const params = new URLSearchParams(window.location.search);
                        const uidParam = params.get('uid');
                        const isAdmin = currentUser.email === ADMIN_EMAIL;
                        
                        // Define quem será editado: o próprio usuário ou o alvo (se for admin)
                        const uidToEdit = (isAdmin && uidParam) ? uidParam : currentUser.uid;
                        setTargetUid(uidToEdit);
                        setIsEditingOther(uidToEdit !== currentUser.uid);

                        try {
                            const docRef = window.firebaseFirestore.doc(db, 'artifacts', appId, 'users', uidToEdit, 'profile', 'data');
                            const docSnap = await window.firebaseFirestore.getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                setUser({ ...currentUser, ...data });
                                setFormData({
                                    name: data.name || '',
                                    minecraftNick: data.minecraftNick || '',
                                    birthDate: data.birthDate || '',
                                    avatarId: data.avatarId || 'villager',
                                    newPassword: '',
                                    confirmPassword: ''
                                });
                                setIsPirate(data.isOriginal === false);
                            }
                        } catch (err) { console.error(err); }
                    } else {
                        window.location.href = 'Portal.html?mode=login';
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handlePirateCheck = (e) => {
                setIsPirate(e.target.checked);
                setNickStatus('idle');
            };

            const handleNickBlur = async () => {
                if (!formData.minecraftNick || isPirate) return;
                setNickStatus('checking');
                const exists = await checkMinecraftNickExists(formData.minecraftNick);
                setNickStatus(exists ? 'valid' : 'invalid');
            };

            const handleSave = async (e) => {
                e.preventDefault();

                if (!isPirate && formData.minecraftNick) {
                    if (nickStatus !== 'valid') {
                        const exists = await checkMinecraftNickExists(formData.minecraftNick);
                        if (!exists) {
                            setNickStatus('invalid');
                            setMessage({ type: 'error', text: 'O nick do Minecraft informado não existe ou está incorreto.' });
                            return;
                        }
                        setNickStatus('valid');
                    }
                }

                if (nickStatus === 'invalid' && !isPirate) {
                    setMessage({ type: 'error', text: 'O nick do Minecraft informado não existe ou está incorreto.' });
                    return;
                }
                setSaving(true);
                setMessage({ type: '', text: '' });

                try {
                    // Atualizar dados no Firestore
                    const docRef = window.firebaseFirestore.doc(db, 'artifacts', appId, 'users', targetUid, 'profile', 'data');
                    await window.firebaseFirestore.updateDoc(docRef, {
                        name: formData.name,
                        minecraftNick: formData.minecraftNick,
                        birthDate: formData.birthDate,
                        avatarId: formData.avatarId,
                        isOriginal: !isPirate
                    });

                    // Atualizar Senha (se fornecida)
                    if (formData.newPassword && !isEditingOther) {
                        if (formData.newPassword !== formData.confirmPassword) {
                            throw new Error("As senhas não coincidem.");
                        }
                        if (formData.newPassword.length < 6) {
                            throw new Error("A senha deve ter no mínimo 6 caracteres.");
                        }
                        await window.firebaseAuth.updatePassword(auth.currentUser, formData.newPassword);
                    }

                    setMessage({ type: 'success', text: 'Perfil atualizado com sucesso!' });
                    setFormData(prev => ({ ...prev, newPassword: '', confirmPassword: '' }));
                } catch (err) {
                    setMessage({ type: 'error', text: err.message.includes('requires-recent-login') ? 'Para mudar a senha, saia e entre novamente.' : err.message });
                } finally {
                    setSaving(false);
                }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-amber-500"><Icon name="loader-2" className="w-10 h-10 animate-spin" /></div>;

            return (
                <main className="max-w-4xl mx-auto px-3 sm:px-4 py-4 sm:py-8 w-full animate-fade-in relative">
                    <div className="absolute inset-0 bg-pattern z-0 pointer-events-none"></div>
                    
                    <div className="relative z-10">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 sm:mb-6 gap-3 sm:gap-0">
                            <h1 className="text-xl sm:text-2xl font-bold text-white flex items-center gap-2">
                                <Icon name="user-cog" className="w-6 h-6 sm:w-8 sm:h-8 text-purple-500" /> {isEditingOther ? 'Editando Usuário (Admin)' : 'Meu Perfil'}
                            </h1>
                            <a href="Portal.html" className="text-slate-400 hover:text-white flex items-center gap-1 text-xs sm:text-sm font-bold transition self-end sm:self-auto no-underline">
                                <Icon name="arrow-left" className="w-3 h-3 sm:w-4 sm:h-4" /> Voltar ao Portal
                            </a>
                        </div>

                        <div className="bg-slate-900/80 backdrop-blur-md border border-slate-800 rounded-2xl p-4 sm:p-6 md:p-8 shadow-2xl">
                            <form onSubmit={handleSave} className="space-y-4 sm:space-y-6">
                                
                                {/* Avatar Section */}
                                <div className="space-y-3">
                                    <label className="text-sm font-bold text-slate-300">Seu Brasão (Classe)</label>
                                    <div className="flex flex-col md:flex-row gap-6 items-start">
                                        <div className="flex-shrink-0 flex flex-col items-center gap-2">
                                            <div className="w-24 h-24 rounded-lg bg-slate-950 border-2 border-purple-500 flex items-center justify-center relative overflow-hidden shadow-lg">
                                                <img src={`https://minotar.net/helm/${formData.minecraftNick || 'MHF_Steve'}/100.png`} alt="Skin" className="w-full h-full object-cover" />
                                                <div className="absolute -bottom-2 -right-2 bg-slate-900 rounded-full p-2 border border-slate-700 z-20 shadow-sm">
                                                    <Icon name={AVATARS.find(a => a.id === formData.avatarId)?.icon || 'shield'} className={`w-5 h-5 ${AVATARS.find(a => a.id === formData.avatarId)?.color || 'text-slate-400'}`} />
                                                </div>
                                            </div>
                                            <span className="text-xs text-slate-500">Visualização</span>
                                        </div>
                                        
                                        <div className="flex-1 grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 max-h-48 overflow-y-auto custom-scrollbar p-1">
                                            {AVATARS.map(av => (
                                                <div key={av.id} title={av.label} onClick={() => setFormData({...formData, avatarId: av.id})} 
                                                     className={`cursor-pointer p-2 rounded-lg border flex flex-col items-center justify-center gap-1 hover:bg-slate-800 transition ${formData.avatarId === av.id ? 'border-purple-500 bg-purple-500/20' : 'border-slate-700 bg-slate-950'}`}>
                                                    <Icon name={av.icon} className={`w-5 h-5 ${av.color}`} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Campos de Formulário */}
                                <div className="grid md:grid-cols-2 gap-6">
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400 ml-1">Nome Real <span className="text-[10px] text-slate-500 font-normal">(Nome e Sobrenome)</span></label>
                                        <div className="relative">
                                            <input type="text" maxLength={25} placeholder="Ex: João Silva" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 pl-10 text-white outline-none focus:border-purple-500 transition" />
                                            <div className="absolute left-3 top-3.5 text-slate-500"><Icon name="user" className="w-5 h-5" /></div>
                                        </div>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs text-slate-400 ml-1">Data de Nascimento</label>
                                        <div className="relative">
                                            <input type="date" value={formData.birthDate} onChange={e => setFormData({...formData, birthDate: e.target.value})} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 pl-10 text-white outline-none focus:border-purple-500 transition" />
                                            <div className="absolute left-3 top-3.5 text-slate-500"><Icon name="calendar" className="w-5 h-5" /></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    <label className="text-xs text-amber-500/80 font-bold ml-1">{isPirate ? 'Nick Exato (Para Login)' : 'Nick do Minecraft'}</label>
                                    <div className="relative">
                                        <input 
                                            type="text" 
                                            value={formData.minecraftNick} 
                                            onChange={e => { setFormData({...formData, minecraftNick: e.target.value}); setNickStatus('idle'); }}
                                            onBlur={handleNickBlur}
                                            className={`w-full bg-slate-950 border ${nickStatus === 'invalid' && !isPirate ? 'border-red-500' : (nickStatus === 'valid' && !isPirate ? 'border-green-500' : 'border-slate-700')} rounded-lg p-3 pl-10 text-white outline-none focus:border-purple-500 transition`}
                                        />
                                        <div className="absolute left-3 top-3.5 text-slate-500"><Icon name="gamepad-2" className="w-5 h-5" /></div>
                                        {nickStatus === 'checking' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="loader-2" className="w-5 h-5 animate-spin text-amber-500" /></div>}
                                        {nickStatus === 'valid' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="check" className="w-5 h-5 text-green-500" /></div>}
                                        {nickStatus === 'invalid' && !isPirate && <div className="absolute right-3 top-3.5"><Icon name="x" className="w-5 h-5 text-red-500" /></div>}
                                    </div>
                                    {nickStatus === 'invalid' && !isPirate && <p className="text-xs text-red-400 ml-1">Este nick não existe no Minecraft Original.</p>}
                                </div>

                                <div className="space-y-1">
                                    <div className="flex items-center justify-start gap-2">
                                        <input id="pirate-check" type="checkbox" checked={isPirate} onChange={handlePirateCheck} className="h-4 w-4 bg-slate-800 border-slate-600 rounded text-purple-500 focus:ring-purple-500 focus:ring-offset-slate-900" />
                                        <label htmlFor="pirate-check" className="text-xs text-slate-400 cursor-pointer select-none">Não tenho Minecraft Original</label>
                                    </div>
                                </div>

                                {!isEditingOther && (
                                    <div className="border-t border-slate-800 pt-6 mt-6">
                                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icon name="lock" className="w-5 h-5 text-amber-500" /> Segurança</h3>
                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div className="space-y-1">
                                                <label className="text-xs text-slate-400 ml-1">Nova Senha (Opcional)</label>
                                                <input type="password" placeholder="Deixe em branco para manter" value={formData.newPassword} onChange={e => setFormData({...formData, newPassword: e.target.value})} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-purple-500 transition" />
                                            </div>
                                            <div className="space-y-1">
                                                <label className="text-xs text-slate-400 ml-1">Confirmar Nova Senha</label>
                                                <input type="password" placeholder="Repita a nova senha" value={formData.confirmPassword} onChange={e => setFormData({...formData, confirmPassword: e.target.value})} className="w-full bg-slate-950 border border-slate-700 rounded-lg p-3 text-white outline-none focus:border-purple-500 transition" />
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {message.text && (
                                    <div className={`p-4 rounded-lg flex items-center gap-2 ${message.type === 'success' ? 'bg-emerald-500/10 border border-emerald-500/20 text-emerald-400' : 'bg-red-500/10 border border-red-500/20 text-red-400'}`}>
                                        <Icon name={message.type === 'success' ? 'check-circle' : 'alert-circle'} className="w-5 h-5" />
                                        {message.text}
                                    </div>
                                )}

                                <div className="flex flex-col-reverse sm:flex-row justify-end gap-3 sm:gap-4 pt-4">
                                    <a href="Portal.html" className="px-6 py-3 rounded-lg border border-slate-700 text-slate-300 hover:bg-slate-800 hover:text-white font-bold transition text-center">Cancelar</a>
                                    <button type="submit" disabled={saving || (nickStatus === 'invalid' && !isPirate)} className="px-8 py-3 bg-gradient-to-r from-purple-700 to-indigo-600 hover:from-purple-600 hover:to-indigo-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2 transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {saving ? 'Salvando...' : 'Salvar Alterações'} <Icon name="save" className="w-4 h-4" />
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </main>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ProfileApp />);
    </script>
</body>
</html>
